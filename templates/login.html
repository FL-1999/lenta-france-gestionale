{% extends "shared/base.html" %}

{% block title %}Login ‚Äì Lenta France{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">üîê Login</h1>
    <p class="page-subtitle">
        Accedi al gestionale con le tue credenziali. In base al ruolo verrai
        reindirizzato automaticamente all‚Äôarea corretta.
    </p>
</div>

<section class="form-card">
    <form id="login-form">
        <div class="form-row">
            <label for="email">üìß Email</label>
            <input type="email" id="email" name="email" required
                   placeholder="es. lenta.federico@gmail.com" />
        </div>

        <div class="form-row">
            <label for="password">üîë Password</label>
            <input type="password" id="password" name="password" required
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <div id="login-error" class="error-text" style="display: none;"></div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">‚û°Ô∏è Entra</button>
            <a href="/" class="btn btn-secondary">‚¨ÖÔ∏è Torna alla home</a>
        </div>
    </form>
</section>

<script>
document.getElementById("login-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const email = (document.getElementById("email").value || "").trim();
    const password = (document.getElementById("password").value || "").trim();
    const errorBox = document.getElementById("login-error");
    errorBox.style.display = "none";
    errorBox.textContent = "";

    if (!email || !password) {
        errorBox.textContent = "Inserisci email e password.";
        errorBox.style.display = "block";
        return;
    }

    try {
        const resp = await fetch("/auth/login", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password }),
        });

        if (!resp.ok) {
            errorBox.textContent = "Credenziali non valide.";
            errorBox.style.display = "block";
            return;
        }

        const data = await resp.json();
        const token = data.access_token;

        if (token) {
            // Salva il token per tutte le chiamate future
            localStorage.setItem("lf_token", token);

            try {
                // Decodifica payload JWT per leggere il ruolo
                const payloadPart = token.split(".")[1];
                const decoded = JSON.parse(
                    atob(payloadPart.replace(/-/g, "+").replace(/_/g, "/"))
                );
                const role = decoded.role || decoded["role"];

                if (role === "admin" || role === "manager") {
                    window.location.href = "/manager/dashboard";
                } else if (role === "caposquadra") {
                    window.location.href = "/capo/dashboard";
                } else {
                    // Ruolo sconosciuto ‚Üí almeno torno alla home
                    window.location.href = "/";
                }
            } catch (e) {
                console.error("Errore decodifica token:", e);
                window.location.href = "/";
            }
        } else {
            errorBox.textContent = "Login riuscito, ma il token non √® stato ricevuto.";
            errorBox.style.display = "block";
        }
    } catch (err) {
        console.error(err);
        errorBox.textContent = "Errore di connessione al server.";
        errorBox.style.display = "block";
    }
});
</script>
{% endblock %}
