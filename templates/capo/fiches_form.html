{% extends "shared/base.html" %}
{% block title %}
    {% set lang = request.cookies.get('lang', 'it') %}
    {% if lang == 'fr' %}Nouvelle fiche – Chef d'équipe{% else %}Nuova fiche – Caposquadra{% endif %}
{% endblock %}
{% block content %}
{% set lang = request.cookies.get('lang', 'it') %}

<div class="form-page">
    <div class="form-page-header">
        <p class="page-eyebrow">
            {% if lang == 'fr' %}Espace Chef d'équipe{% else %}Area Caposquadra{% endif %}
        </p>
        <h1 class="page-title">
            {% if lang == 'fr' %}Nouvelle fiche{% else %}Nuova fiche{% endif %}
        </h1>
        <p class="page-subtitle">
            {% if lang == 'fr' %}
                Renseignez les informations pour enregistrer une nouvelle fiche liée à vos chantiers.
            {% else %}
                Compila le informazioni per registrare una nuova fiche sui cantieri assegnati.
            {% endif %}
        </p>
    </div>

    <div class="card form-card">
        <div class="card-body">
            <form method="post" class="form-grid form-grid--single">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="cantiere_id">
                            {% if lang == 'fr' %}Chantier*{% else %}Cantiere*{% endif %}
                        </label>
                        <select id="cantiere_id" name="cantiere_id" class="form-select" required>
                            <option value="">
                                {% if lang == 'fr' %}Sélectionnez un chantier{% else %}Seleziona un cantiere{% endif %}
                            </option>
                            {% for c in cantieri %}
                                <option value="{{ c.id }}">{{ c.name }}{% if c.code %} ({{ c.code }}){% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="macchinario_id">
                            {% if lang == 'fr' %}Macchinario{% else %}Macchinario{% endif %}
                        </label>
                        <select id="macchinario_id" name="macchinario_id" class="form-select">
                            <option value="">
                                {% if lang == 'fr' %}Aucun{% else %}Nessuno{% endif %}
                            </option>
                            {% for m in macchinari %}
                                <option value="{{ m.id }}">{{ m.name }}{% if m.code %} ({{ m.code }}){% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="data">
                            {% if lang == 'fr' %}Date*{% else %}Data*{% endif %}
                        </label>
                        <input id="data" name="data" type="date" class="form-control" required />
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="operatore">
                            {% if lang == 'fr' %}Opérateur / équipe*{% else %}Operatore / squadra*{% endif %}
                        </label>
                        <input id="operatore" name="operatore" class="form-control" required />
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="descrizione">
                        {% if lang == 'fr' %}Description des travaux*{% else %}Descrizione lavori*{% endif %}
                    </label>
                    <textarea id="descrizione" name="descrizione" class="form-textarea" rows="4" required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="ore_lavorate">
                        {% if lang == 'fr' %}Heures travaillées*{% else %}Ore lavorate*{% endif %}
                    </label>
                    <input id="ore_lavorate" name="ore_lavorate" type="number" step="0.25" min="0" class="form-control" required />
                </div>

                <h3 class="form-section-title">
                    {% if lang == 'fr' %}
                        Excavation et stratigraphie
                    {% else %}
                        Scavo e stratigrafia
                    {% endif %}
                </h3>

                <div class="form-group">
                    <label class="form-label" for="tipologia_scavo">
                        {% if lang == 'fr' %}
                            Type d'excavation
                        {% else %}
                            Tipologia di scavo
                        {% endif %}
                    </label>
                    <select id="tipologia_scavo" name="tipologia_scavo" class="form-select">
                        <option value="">
                            {% if lang == 'fr' %}Aucun{% else %}Nessuna{% endif %}
                        </option>
                        <option value="palo">
                            {% if lang == 'fr' %}Pieu (palo){% else %}Palo{% endif %}
                        </option>
                        <option value="paratia">
                            {% if lang == 'fr' %}Paroi (paratia){% else %}Paratia{% endif %}
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="materiale">
                        {% if lang == 'fr' %}
                            Matériau de la stratigraphie
                        {% else %}
                            Materiale della stratigrafia
                        {% endif %}
                    </label>
                    <select id="materiale" name="materiale" class="form-select">
                        <option value="">
                            {% if lang == 'fr' %}Sélectionnez un matériau{% else %}Seleziona un materiale{% endif %}
                        </option>
                        <option value="argilla">
                            {% if lang == 'fr' %}Argile{% else %}Argilla{% endif %}
                        </option>
                        <option value="riporto">
                            {% if lang == 'fr' %}Remblai{% else %}Riporto{% endif %}
                        </option>
                        <option value="sabbia">
                            {% if lang == 'fr' %}Sable{% else %}Sabbia{% endif %}
                        </option>
                        <option value="ghiaia">
                            {% if lang == 'fr' %}Gravier{% else %}Ghiaia{% endif %}
                        </option>
                        <option value="roccia">
                            {% if lang == 'fr' %}Roche{% else %}Roccia{% endif %}
                        </option>
                        <option value="altro">
                            {% if lang == 'fr' %}Autre{% else %}Altro{% endif %}
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="stratigrafia">
                        {% if lang == 'fr' %}
                            Stratigraphie (description)
                        {% else %}
                            Stratigrafia (descrizione)
                        {% endif %}
                    </label>
                    <textarea id="stratigrafia" name="stratigrafia" class="form-textarea" rows="3"></textarea>
                </div>

                <h2 class="page-title" style="font-size: 1.1rem; margin-top: 1.5rem;">
                    {% if lang == 'fr' %}
                        Stratigraphie de l'excavation
                    {% else %}
                        Stratigrafia dello scavo
                    {% endif %}
                </h2>

                <p class="text-muted" style="margin-bottom: 0.75rem;">
                    {% if lang == 'fr' %}
                        Ajoutez les couches de sol rencontrées (de m à m, avec le matériau).
                    {% else %}
                        Aggiungi gli strati di terreno incontrati (da m a m, con il materiale).
                    {% endif %}
                </p>

                <div class="card fiche-sketch">
                    <div class="card-body">
                        <div id="strati-container">
                            <div class="form-grid strato-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        {% if lang == 'fr' %}De (m){% else %}Da (m){% endif %}
                                    </label>
                                    <input type="number" step="0.1" min="0" name="strato_da" class="form-control" />
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        {% if lang == 'fr' %}À (m){% else %}A (m){% endif %}
                                    </label>
                                    <input type="number" step="0.1" min="0" name="strato_a" class="form-control" />
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        {% if lang == 'fr' %}Matériau{% else %}Materiale{% endif %}
                                    </label>
                                    <select name="strato_materiale" class="form-select">
                                        <option value="">
                                            {% if lang == 'fr' %}Sélectionnez{% else %}Seleziona{% endif %}
                                        </option>
                                        <option value="argilla">
                                            {% if lang == 'fr' %}Argile{% else %}Argilla{% endif %}
                                        </option>
                                        <option value="riporto">
                                            {% if lang == 'fr' %}Remblai{% else %}Riporto{% endif %}
                                        </option>
                                        <option value="sabbia">
                                            {% if lang == 'fr' %}Sable{% else %}Sabbia{% endif %}
                                        </option>
                                        <option value="ghiaia">
                                            {% if lang == 'fr' %}Gravier{% else %}Ghiaia{% endif %}
                                        </option>
                                        <option value="roccia">
                                            {% if lang == 'fr' %}Roche{% else %}Roccia{% endif %}
                                        </option>
                                        <option value="altro">
                                            {% if lang == 'fr' %}Autre{% else %}Altro{% endif %}
                                        </option>
                                    </select>
                                </div>
                                <div class="form-group" style="align-self: flex-end;">
                                    <button type="button" class="btn btn-secondary btn-sm remove-strato" style="display:none;">
                                        {% if lang == 'fr' %}Supprimer{% else %}Rimuovi{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 0.75rem;">
                            <button type="button" id="add-strato-btn" class="btn btn-primary btn-sm">
                                ➕
                                {% if lang == 'fr' %}
                                    Ajouter une couche
                                {% else %}
                                    Aggiungi strato
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        {% if lang == 'fr' %}
                            Schéma de l'élément (palo / paratia)
                        {% else %}
                            Disegno dell'elemento (palo / paratia)
                        {% endif %}
                    </label>

                    <div class="card fiche-sketch">
                        <div class="card-body">
                            <svg id="fiche-sketch-svg" width="140" height="140" viewBox="0 0 140 140">
                                <!-- Cerchio per PALO -->
                                <circle id="sketch-palo" cx="70" cy="70" r="35" stroke="currentColor"
                                        stroke-width="4" fill="none" style="display: none;" />
                                <!-- Rettangolo per PARATIA -->
                                <rect id="sketch-paratia" x="30" y="35" width="80" height="70"
                                      stroke="currentColor" stroke-width="4" fill="none" style="display: none;" />
                            </svg>
                            <p class="text-muted" id="fiche-sketch-label" style="margin-top: 0.5rem;">
                                {% if lang == 'fr' %}
                                    Sélectionnez "palo" ou "paratia" pour voir le schéma.
                                {% else %}
                                    Seleziona "palo" o "paratia" per vedere il disegno.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="note">
                        {% if lang == 'fr' %}Remarques{% else %}Note{% endif %}
                    </label>
                    <textarea id="note" name="note" class="form-textarea" rows="3"></textarea>
                </div>

                <div class="form-actions">
                    <a href="/capo/dashboard" class="btn btn-secondary">
                        {% if lang == 'fr' %}Annuler{% else %}Annulla{% endif %}
                    </a>
                    <button type="submit" class="btn btn-primary">
                        {% if lang == 'fr' %}Enregistrer{% else %}Salva{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById("strati-container");
    const addBtn = document.getElementById("add-strato-btn");
    if (!container || !addBtn) return;

    function bindRemoveButtons() {
        const rows = container.querySelectorAll(".strato-row");
        rows.forEach((row, index) => {
            const removeBtn = row.querySelector(".remove-strato");
            if (!removeBtn) return;
            if (index === 0 && rows.length === 1) {
                removeBtn.style.display = "none";
            } else {
                removeBtn.style.display = "inline-flex";
                removeBtn.onclick = function () {
                    row.remove();
                    bindRemoveButtons();
                };
            }
        });
    }

    addBtn.addEventListener("click", function () {
        const rows = container.querySelectorAll(".strato-row");
        if (rows.length === 0) return;
        const templateRow = rows[0];
        const clone = templateRow.cloneNode(true);

        clone.querySelectorAll("input").forEach((input) => { input.value = ""; });
        clone.querySelectorAll("select").forEach((sel) => { sel.value = ""; });

        container.appendChild(clone);
        bindRemoveButtons();
    });

    bindRemoveButtons();
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const selectType = document.getElementById("tipologia_scavo");
    if (!selectType) return;

    const circle = document.getElementById("sketch-palo");
    const rect = document.getElementById("sketch-paratia");
    const label = document.getElementById("fiche-sketch-label");

    function updateSketch() {
        const value = selectType.value;
        if (value === "palo") {
            if (circle) circle.style.display = "block";
            if (rect) rect.style.display = "none";
        } else if (value === "paratia") {
            if (circle) circle.style.display = "none";
            if (rect) rect.style.display = "block";
        } else {
            if (circle) circle.style.display = "none";
            if (rect) rect.style.display = "none";
        }
    }

    selectType.addEventListener("change", updateSketch);
    updateSketch();
});
</script>

{% endblock %}
