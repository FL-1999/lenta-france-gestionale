{% extends "shared/base.html" %}
{% block title %}
    {% set lang = request.cookies.get('lang', 'it') %}
    {% if lang == 'fr' %}Nouvelle fiche – Chef d'équipe{% else %}Nuova fiche – Caposquadra{% endif %}
{% endblock %}
{% block content %}
{% set lang = request.cookies.get('lang', 'it') %}
{% set form_data = form_data or {} %}

<div class="form-page">
    <div class="form-page-header">
        <p class="page-eyebrow">
            {% if lang == 'fr' %}Espace Chef d'équipe{% else %}Area Caposquadra{% endif %}
        </p>
        <h1 class="page-title">
            {% if lang == 'fr' %}Nouvelle fiche{% else %}Nuova fiche{% endif %}
        </h1>
        <p class="page-subtitle">
            {% if lang == 'fr' %}
                Renseignez les informations pour enregistrer une nouvelle fiche liée à vos chantiers.
            {% else %}
                Compila le informazioni per registrare una nuova fiche sui cantieri assegnati.
            {% endif %}
        </p>
    </div>

    <div class="card form-card">
        <div class="card-body">
            {% if error_message %}
                <div class="alert alert-danger" role="alert">
                    {{ error_message }}
                </div>
            {% endif %}

            {% set selected_site = form_data.get('cantiere_id', '') %}
            {% set selected_machine = form_data.get('macchinario_id', '') %}
            {% set selected_tipologia = form_data.get('tipologia_scavo', '') %}
            {% set diametro_value_cm = "" %}
            {% if form_data is defined %}
              {% if form_data.get('diametro_palo_cm') %}
                {% set diametro_value_cm = form_data.get('diametro_palo_cm') %}
              {% elif form_data.get('diametro_palo') %}
                {% set diametro_value_cm = (form_data.get('diametro_palo')|float * 100)|round(1) %}
              {% endif %}
            {% endif %}

            <form method="post" class="form-grid form-grid--single">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="cantiere_id">
                            {% if lang == 'fr' %}Chantier*{% else %}Cantiere*{% endif %}
                        </label>
                        <select id="cantiere_id" name="cantiere_id" class="form-select" required>
                            <option value="">
                                {% if lang == 'fr' %}Sélectionnez un chantier{% else %}Seleziona un cantiere{% endif %}
                            </option>
                            {% for c in cantieri %}
                                <option value="{{ c.id }}" {% if selected_site == c.id|string %}selected{% endif %}>
                                    {{ c.name }}{% if c.code %} ({{ c.code }}){% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="macchinario_id">
                            {% if lang == 'fr' %}Macchinario{% else %}Macchinario{% endif %}
                        </label>
                        <select id="macchinario_id" name="macchinario_id" class="form-select">
                            <option value="">
                                {% if lang == 'fr' %}Aucun{% else %}Nessuno{% endif %}
                            </option>
                            {% for m in macchinari %}
                                <option value="{{ m.id }}" {% if selected_machine == m.id|string %}selected{% endif %}>
                                    {{ m.name }}{% if m.code %} ({{ m.code }}){% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="data_scavo">
                            {% if lang == 'fr' %}
                                Date de forage*
                            {% else %}
                                Data di scavo*
                            {% endif %}
                        </label>
                        <input id="data_scavo"
                               name="data_scavo"
                               type="date"
                               class="form-control"
                               value="{{ form_data.get('data_scavo', '') }}"
                               required />
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="data_getto">
                            {% if lang == 'fr' %}
                                Date de bétonnage
                            {% else %}
                                Data di getto
                            {% endif %}
                        </label>
                        <input id="data_getto"
                               name="data_getto"
                               type="date"
                               class="form-control"
                               value="{{ form_data.get('data_getto', '') }}" />
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="operatore">
                            {% if lang == 'fr' %}Opérateur / équipe*{% else %}Operatore / squadra*{% endif %}
                        </label>
                        <input id="operatore"
                               name="operatore"
                               class="form-control"
                               value="{{ form_data.get('operatore', '') }}"
                               required />
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="ore_lavorate">
                        {% if lang == 'fr' %}Heures travaillées*{% else %}Ore lavorate*{% endif %}
                    </label>
                    <input id="ore_lavorate"
                           name="ore_lavorate"
                           type="number"
                           step="0.25"
                           min="0"
                           class="form-control"
                           value="{{ form_data.get('ore_lavorate', '') }}"
                           required />
                </div>

                <div class="form-group">
                    <label class="form-label" for="metri_cubi_gettati">
                        {% if lang == 'fr' %}
                            Mètres cubes bétonnés
                        {% else %}
                            Metri cubi gettati
                        {% endif %}
                    </label>
                    <input id="metri_cubi_gettati"
                           name="metri_cubi_gettati"
                           type="number"
                           step="0.1"
                           min="0"
                           class="form-control"
                           value="{{ form_data.get('metri_cubi_gettati', '') }}" />
                </div>

                <h3 class="form-section-title">
                    {% if lang == 'fr' %}
                        Excavation et stratigraphie
                    {% else %}
                        Scavo e stratigrafia
                    {% endif %}
                </h3>

                <div class="form-group">
                    <label class="form-label" for="tipologia_scavo">
                        {% if lang == 'fr' %}
                            Type d'excavation
                        {% else %}
                            Tipologia di scavo
                        {% endif %}
                    </label>
                    <select id="tipologia_scavo" name="tipologia_scavo" class="form-select">
                        <option value="">
                            {% if lang == 'fr' %}Aucun{% else %}Nessuna{% endif %}
                        </option>
                        <option value="palo" {% if selected_tipologia == 'palo' %}selected{% endif %}>
                            {% if lang == 'fr' %}Pieu (palo){% else %}Palo{% endif %}
                        </option>
                        <option value="paratia" {% if selected_tipologia == 'paratia' %}selected{% endif %}>
                            {% if lang == 'fr' %}Paroi (paratia){% else %}Paratia{% endif %}
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="stratigrafia">
                        {% if lang == 'fr' %}
                            Stratigraphie (description)
                        {% else %}
                            Stratigrafia (descrizione)
                        {% endif %}
                    </label>
                    <textarea id="stratigrafia"
                              name="stratigrafia"
                              class="form-textarea"
                              rows="3">{{ form_data.get('stratigrafia', '') }}</textarea>
                </div>

                <h2 class="page-title" style="font-size: 1.1rem; margin-top: 1.5rem;">
                    {% if lang == 'fr' %}
                        Stratigraphie de l'excavation
                    {% else %}
                        Stratigrafia dello scavo
                    {% endif %}
                </h2>

                <p class="text-muted" style="margin-bottom: 0.75rem;">
                    {% if lang == 'fr' %}
                        Ajoutez les couches de sol rencontrées (de m à m, avec le matériau).
                    {% else %}
                        Aggiungi gli strati di terreno incontrati (da m a m, con il materiale).
                    {% endif %}
                </p>

                <div class="card fiche-sketch">
                    <div class="card-body">
                        {% set strati = form_data.get('strati', []) %}
                        {% if not strati %}
                            {% set strati = [{'da': '', 'a': '', 'materiale': ''}] %}
                        {% endif %}

                        <div id="strati-container">
                            {% for strato in strati %}
                            <div class="form-grid strato-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        {% if lang == 'fr' %}De (m){% else %}Da (m){% endif %}
                                    </label>
                                    <input type="number"
                                           step="0.1"
                                           min="0"
                                           name="strato_da"
                                           class="form-control"
                                           value="{{ strato.da }}" />
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        {% if lang == 'fr' %}À (m){% else %}A (m){% endif %}
                                    </label>
                                    <input type="number"
                                           step="0.1"
                                           min="0"
                                           name="strato_a"
                                           class="form-control"
                                           value="{{ strato.a }}" />
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        {% if lang == 'fr' %}Matériau{% else %}Materiale{% endif %}
                                    </label>
                                    <select name="strato_materiale" class="form-select">
                                        <option value="">
                                            {% if lang == 'fr' %}Sélectionnez{% else %}Seleziona{% endif %}
                                        </option>
                                        <option value="argilla" {% if strato.materiale == 'argilla' %}selected{% endif %}>
                                            {% if lang == 'fr' %}Argile{% else %}Argilla{% endif %}
                                        </option>
                                        <option value="riporto" {% if strato.materiale == 'riporto' %}selected{% endif %}>
                                            {% if lang == 'fr' %}Remblai{% else %}Riporto{% endif %}
                                        </option>
                                        <option value="sabbia" {% if strato.materiale == 'sabbia' %}selected{% endif %}>
                                            {% if lang == 'fr' %}Sable{% else %}Sabbia{% endif %}
                                        </option>
                                        <option value="ghiaia" {% if strato.materiale == 'ghiaia' %}selected{% endif %}>
                                            {% if lang == 'fr' %}Gravier{% else %}Ghiaia{% endif %}
                                        </option>
                                        <option value="roccia" {% if strato.materiale == 'roccia' %}selected{% endif %}>
                                            {% if lang == 'fr' %}Roche{% else %}Roccia{% endif %}
                                        </option>
                                        <option value="altro" {% if strato.materiale == 'altro' %}selected{% endif %}>
                                            {% if lang == 'fr' %}Autre{% else %}Altro{% endif %}
                                        </option>
                                    </select>
                                </div>
                                <div class="form-group" style="align-self: flex-end;">
                                    <button type="button" class="btn btn-secondary btn-sm remove-strato" style="display:none;">
                                        {% if lang == 'fr' %}Supprimer{% else %}Rimuovi{% endif %}
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div style="margin-top: 0.75rem;">
                            <button type="button" id="add-strato-btn" class="btn btn-primary btn-sm">
                                ➕
                                {% if lang == 'fr' %}
                                    Ajouter une couche
                                {% else %}
                                    Aggiungi strato
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        {% if lang == 'fr' %}
                            Schéma de l'élément (palo / paratia)
                        {% else %}
                            Disegno dell'elemento (palo / paratia)
                        {% endif %}
                    </label>

                    <div class="card fiche-sketch">
                        <div class="card-body">
                            <div class="element-drawing-label">
                              {% if diametro_value_cm %}
                                {{ diametro_value_cm }} cm
                              {% else %}
                                Inserisci diametro (cm)
                              {% endif %}
                            </div>
                            <svg id="fiche-sketch-svg" width="140" height="140" viewBox="0 0 140 140">
                                <circle id="sketch-palo"
                                        cx="70" cy="70" r="35"
                                        stroke="currentColor"
                                        stroke-width="4"
                                        fill="none"
                                        style="display: none;" />

                                <rect id="sketch-paratia"
                                      x="20" y="40" width="100" height="50"
                                      stroke="currentColor"
                                      stroke-width="4"
                                      fill="none"
                                      style="display: none;" />

                                <text id="label-diametro"
                                      x="70" y="20"
                                      text-anchor="middle"
                                      font-size="10"
                                      style="display:none;">
                                  {% if diametro_value_cm %}
                                    {{ diametro_value_cm }} cm
                                  {% else %}
                                    Inserisci diametro (cm)
                                  {% endif %}
                                </text>

                                <text id="label-larghezza"
                                      x="70" y="110"
                                      text-anchor="middle"
                                      font-size="10"
                                      style="display:none;">
                                </text>

                                <text id="label-altezza"
                                      x="15" y="65"
                                      text-anchor="middle"
                                      font-size="10"
                                      transform="rotate(-90 15 65)"
                                      style="display:none;">
                                </text>
                            </svg>
                            <p class="text-muted" id="fiche-sketch-label" style="margin-top: 0.5rem;">
                                {% if lang == 'fr' %}
                                    Sélectionnez "palo" ou "paratia" pour voir le schéma.
                                {% else %}
                                    Seleziona "palo" o "paratia" per vedere il disegno.
                                {% endif %}
                            </p>

                            <hr style="margin: 1rem 0; border-color: rgba(0,0,0,0.05);" />

                            <div class="geometry-note geometry-note--emphasis">
                                {% if lang == 'fr' %}
                                    Remplissez seulement l'un des deux : pieu OU panneau.
                                {% else %}
                                    Compila solo uno dei due: palo O pannello.
                                {% endif %}
                            </div>

                            <div class="geometry-layout">
                                <div class="geometry-block geometry-block--depth">
                                    <div class="geometry-section-header">
                                        <h4 class="geometry-section-title">
                                            {% if lang == 'fr' %}
                                                Profondeur totale excavée
                                            {% else %}
                                                Profondità totale scavata
                                            {% endif %}
                                        </h4>
                                    </div>
                                    <div class="form-group geometry-field">
                                        <label class="form-label geometry-label" for="profondita_totale">
                                            {% if lang == 'fr' %}
                                                Mesure de profondeur
                                            {% else %}
                                                Misura profondità
                                            {% endif %}
                                        </label>
                                        <div class="input-with-unit">
                                            <input id="profondita_totale"
                                                   name="profondita_totale"
                                                   type="number"
                                                   step="0.1"
                                                   min="0.1"
                                                   class="form-control geometry-input"
                                                   value="{{ form_data.get('profondita_totale', '') }}" />
                                            <span class="unit-badge">m</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="geometry-blocks">
                                    <div class="geometry-block geom-palo" data-display-default="flex">
                                        <div class="geometry-section-header">
                                            <h4 class="geometry-section-title">
                                                {% if lang == 'fr' %}PALO (cercle){% else %}PALO (cerchio){% endif %}
                                            </h4>
                                        </div>
                                        <div class="form-group geometry-field">
                                            <label class="form-label geometry-label" for="diametro_palo_cm">DIAMETRO PALO</label>
                                            <div class="input-with-unit">
                                                <input id="diametro_palo_cm"
                                                       name="diametro_palo_cm"
                                                       type="number"
                                                       step="1"
                                                       min="1"
                                                       class="form-control geometry-input"
                                                       placeholder="Es. 104"
                                                       value="{{ diametro_value_cm }}" />
                                                <span class="unit-badge">cm</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="geometry-divider geometry-divider--or">
                                        <span class="geometry-divider-line"></span>
                                        <span class="geometry-divider-text">
                                            {% if lang == 'fr' %}OU{% else %}OPPURE{% endif %}
                                        </span>
                                        <span class="geometry-divider-line"></span>
                                    </div>

                                    <div class="geometry-block geom-paratia" data-display-default="flex">
                                        <div class="geometry-section-header">
                                            <h4 class="geometry-section-title">
                                                {% if lang == 'fr' %}PANNELLO (rectangle){% else %}PANNELLO (rettangolo){% endif %}
                                            </h4>
                                        </div>
                                        <div class="form-group geometry-field">
                                            <label class="form-label geometry-label" for="larghezza_pannello">
                                                {% if lang == 'fr' %}
                                                    Longueur panneau
                                                {% else %}
                                                    Lunghezza pannello
                                                {% endif %}
                                            </label>
                                            <div class="input-with-unit">
                                                <input id="larghezza_pannello"
                                                       name="larghezza_pannello"
                                                       type="number"
                                                       step="0.01"
                                                       min="0.01"
                                                       class="form-control geometry-input"
                                                       value="{{ form_data.get('larghezza_pannello', '') }}" />
                                                <span class="unit-badge">m</span>
                                            </div>
                                        </div>
                                        <div class="form-group geometry-field">
                                            <label class="form-label geometry-label" for="altezza_pannello">
                                                {% if lang == 'fr' %}
                                                    Épaisseur panneau
                                                {% else %}
                                                    Spessore pannello
                                                {% endif %}
                                            </label>
                                            <div class="input-with-unit">
                                                <input id="altezza_pannello"
                                                       name="altezza_pannello"
                                                       type="number"
                                                       step="0.01"
                                                       min="0.01"
                                                       class="form-control geometry-input"
                                                       value="{{ form_data.get('altezza_pannello', '') }}" />
                                                <span class="unit-badge">cm</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="note">
                        {% if lang == 'fr' %}Remarques{% else %}Note{% endif %}
                    </label>
                    <textarea id="note" name="note" class="form-textarea" rows="3">{{ form_data.get('note', '') }}</textarea>
                </div>

                <div class="form-actions">
                    <a href="/capo/dashboard" class="btn btn-secondary">
                        {% if lang == 'fr' %}Annuler{% else %}Annulla{% endif %}
                    </a>
                    <button type="submit" class="btn btn-primary">
                        {% if lang == 'fr' %}Enregistrer{% else %}Salva{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById("strati-container");
    const addBtn = document.getElementById("add-strato-btn");
    if (!container || !addBtn) return;

    function bindRemoveButtons() {
        const rows = container.querySelectorAll(".strato-row");
        rows.forEach((row, index) => {
            const removeBtn = row.querySelector(".remove-strato");
            if (!removeBtn) return;
            if (index === 0 && rows.length === 1) {
                removeBtn.style.display = "none";
            } else {
                removeBtn.style.display = "inline-flex";
                removeBtn.onclick = function () {
                    row.remove();
                    bindRemoveButtons();
                };
            }
        });
    }

    addBtn.addEventListener("click", function () {
        const rows = container.querySelectorAll(".strato-row");
        if (rows.length === 0) return;
        const templateRow = rows[0];
        const clone = templateRow.cloneNode(true);

        clone.querySelectorAll("input").forEach((input) => { input.value = ""; });
        clone.querySelectorAll("select").forEach((sel) => { sel.value = ""; });

        container.appendChild(clone);
        bindRemoveButtons();
    });

    bindRemoveButtons();
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const selectType = document.getElementById("tipologia_scavo");

    const circle = document.getElementById("sketch-palo");
    const rect   = document.getElementById("sketch-paratia");

    const geomPalo    = document.querySelectorAll(".geom-palo");
    const geomParatia = document.querySelectorAll(".geom-paratia");

    const diametroInput   = document.getElementById("diametro_palo_cm");
    const larghezzaInput  = document.getElementById("larghezza_pannello");
    const altezzaInput    = document.getElementById("altezza_pannello");

    const elementDrawingLabel = document.querySelector(".element-drawing-label");
    const labelDiametro  = document.getElementById("label-diametro");
    const labelLarghezza = document.getElementById("label-larghezza");
    const labelAltezza   = document.getElementById("label-altezza");

    function setDisplay(elems, display) {
        elems.forEach(function (el) {
            if (!el) return;
            const desiredDisplay = display === "block" && el.dataset.displayDefault
                ? el.dataset.displayDefault
                : display;
            el.style.display = desiredDisplay;
        });
    }

    function updateLabels() {
        const tipo = selectType ? selectType.value : "";

        if (tipo === "palo") {
            const d = diametroInput?.value || "";
            const testoDiametro = d ? d + " cm" : "Inserisci diametro (cm)";

            if (labelDiametro) {
                labelDiametro.textContent = testoDiametro;
                labelDiametro.style.display = "block";
            }
            if (elementDrawingLabel) {
                elementDrawingLabel.textContent = testoDiametro;
            }

            labelLarghezza.style.display = "none";
            labelAltezza.style.display   = "none";

        } else if (tipo === "paratia") {
            const w = larghezzaInput?.value || "";
            const h = altezzaInput?.value || "";

            labelLarghezza.textContent = w ? w + " m" : "";
            labelLarghezza.style.display = w ? "block" : "none";

            labelAltezza.textContent = h ? h + " cm" : "";
            labelAltezza.style.display = h ? "block" : "none";

            if (labelDiametro) {
                labelDiametro.style.display = "none";
            }
            if (elementDrawingLabel) {
                elementDrawingLabel.textContent = "Inserisci diametro (cm)";
            }

        } else {
            if (labelDiametro) {
                labelDiametro.style.display  = "none";
            }
            labelLarghezza.style.display = "none";
            labelAltezza.style.display   = "none";
            if (elementDrawingLabel) {
                elementDrawingLabel.textContent = "Inserisci diametro (cm)";
            }
        }
    }

    function updateSketchAndGeom() {
        const value = selectType ? selectType.value : "";

        if (value === "palo") {
            circle.style.display = "block";
            rect.style.display   = "none";
            setDisplay(geomPalo, "block");
            setDisplay(geomParatia, "none");

        } else if (value === "paratia") {
            circle.style.display = "none";
            rect.style.display   = "block";
            setDisplay(geomPalo, "none");
            setDisplay(geomParatia, "block");

        } else {
            circle.style.display = "none";
            rect.style.display   = "none";
            setDisplay(geomPalo, "none");
            setDisplay(geomParatia, "none");
        }

        updateLabels();
    }

    selectType?.addEventListener("change", updateSketchAndGeom);
    diametroInput?.addEventListener("input", updateLabels);
    larghezzaInput?.addEventListener("input", updateLabels);
    altezzaInput?.addEventListener("input", updateLabels);

    updateSketchAndGeom();
});
</script>

{% endblock %}
