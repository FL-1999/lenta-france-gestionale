{% extends "shared/base.html" %}
{% set lang = request.cookies.get('lang', 'it') %}

{% block title %}
    {% if lang == 'fr' %}Magasin â€“ Chef d'Ã©quipe{% else %}Magazzino â€“ Caposquadra{% endif %}
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-main">
        <h1 class="page-title">ðŸ“¦ {% if lang == 'fr' %}Magasin{% else %}Magazzino{% endif %}</h1>
        <p class="page-subtitle">
            {% if lang == 'fr' %}
                Consultez les articles disponibles et leurs quantitÃ©s.
            {% else %}
                Consulta gli articoli disponibili e le quantitÃ  in magazzino.
            {% endif %}
        </p>
    </div>
    <div class="header-actions">
        <a href="{{ url_for('capo_magazzino_richieste') }}" class="btn btn-secondary">
            ðŸ“„ {% if lang == 'fr' %}Mes demandes{% else %}Le mie richieste{% endif %}
        </a>
        <a href="{{ url_for('capo_magazzino_richiesta_new') }}" class="btn btn-primary">
            âž• {% if lang == 'fr' %}Nouvelle demande{% else %}Nuova richiesta{% endif %}
        </a>
    </div>
</div>

{% for categoria in categorie %}
    {% set category_items = items_by_categoria.get(categoria.key, []) %}
    <section class="magazzino-category">
        <div class="magazzino-category-header">
            <h2>
                {% if lang == 'fr' %}{{ categoria.label_fr }}{% else %}{{ categoria.label_it }}{% endif %}
            </h2>
        </div>
        <div class="magazzino-items-grid">
            {% if category_items %}
                {% for item in category_items %}
                    {% set non_disponibile = item.quantita_disponibile is not none and item.quantita_disponibile <= 0 %}
                    {% set sotto_soglia = (not non_disponibile) and (item.soglia_minima is not none) and (item.quantita_disponibile is not none) and (item.quantita_disponibile < item.soglia_minima) %}
                    <div class="card magazzino-item-card">
                        <div class="card-body">
                            <div class="magazzino-item-header">
                                <h3>{{ item.nome }}</h3>
                                {% if non_disponibile %}
                                    <span class="badge badge-muted">{% if lang == 'fr' %}Indisponible{% else %}Non disponibile{% endif %}</span>
                                {% elif sotto_soglia %}
                                    <span class="badge badge-danger">{% if lang == 'fr' %}Sous seuil{% else %}Sotto soglia{% endif %}</span>
                                {% else %}
                                    <span class="badge badge-success">OK</span>
                                {% endif %}
                            </div>
                            <p class="magazzino-item-meta">
                                <strong>{% if lang == 'fr' %}Code{% else %}Codice{% endif %}:</strong>
                                {{ item.codice or 'â€”' }}
                            </p>
                            <p class="magazzino-item-desc">{{ item.descrizione or 'â€”' }}</p>
                            <div class="magazzino-item-stats">
                                <div>
                                    <span class="label">{% if lang == 'fr' %}QuantitÃ© disponible{% else %}QuantitÃ  disponibile{% endif %}</span>
                                    <span class="kpi-value">
                                        {% if item.quantita_disponibile is not none %}
                                            {{ item.quantita_disponibile }}
                                        {% else %}
                                            â€”
                                        {% endif %}
                                    </span>
                                </div>
                                <div>
                                    <span class="label">{% if lang == 'fr' %}Seuil minimum{% else %}Soglia minima{% endif %}</span>
                                    <span class="value">{{ item.soglia_minima if item.soglia_minima is not none else 'â€”' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="card magazzino-item-card">
                    <div class="card-body">
                        <p class="magazzino-item-desc">
                            {% if lang == 'fr' %}
                                Aucun article dans cette catÃ©gorie.
                            {% else %}
                                Nessun articolo in questa categoria.
                            {% endif %}
                        </p>
                    </div>
                </div>
            {% endif %}
        </div>
    </section>
{% endfor %}
{% endblock %}
