{% extends "shared/base.html" %}
{% set lang = request.cookies.get('lang', 'it') %}

{% block title %}
    {% if lang == 'fr' %}Magasin ‚Äì Chef d'√©quipe{% else %}Magazzino ‚Äì Caposquadra{% endif %}
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-main">
        <h1 class="page-title">üì¶ {% if lang == 'fr' %}Magasin{% else %}Magazzino{% endif %}</h1>
        <p class="page-subtitle">
            {% if lang == 'fr' %}
                Consultez les articles disponibles et leurs quantit√©s.
            {% else %}
                Consulta gli articoli disponibili e le quantit√† in magazzino.
            {% endif %}
        </p>
    </div>
    <div class="header-actions">
        <a href="{{ url_for('capo_magazzino_richieste') }}" class="btn btn-secondary">
            üìÑ {% if lang == 'fr' %}Mes demandes{% else %}Le mie richieste{% endif %}
        </a>
        <a href="{{ url_for('capo_magazzino_richiesta_new') }}" class="btn btn-primary">
            ‚ûï {% if lang == 'fr' %}Nouvelle demande{% else %}Nuova richiesta{% endif %}
        </a>
    </div>
</div>

<div class="card" style="margin-bottom: var(--space-3);">
    <div class="card-header">
        <div class="card-title">
            üîç {% if lang == 'fr' %}Filtres magasin{% else %}Filtri magazzino{% endif %}
        </div>
    </div>
    <div class="card-body">
        <form method="get" class="form-grid">
            <div class="form-group">
                <label for="search_q" class="form-label">
                    {% if lang == 'fr' %}Code ou nom{% else %}Codice o nome{% endif %}
                </label>
                <input type="text" id="search_q" name="q" class="form-control" value="{{ filters.q or '' }}">
            </div>
            <div class="form-group">
                <label for="categoria" class="form-label">
                    {% if lang == 'fr' %}Macro cat√©gorie{% else %}Macro categoria{% endif %}
                </label>
                <select id="categoria" name="categoria" class="form-select">
                    <option value="">{% if lang == 'fr' %}Toutes{% else %}Tutte{% endif %}</option>
                    {% if fallback_categoria.id is none %}
                        <option value="none" {% if filters.categoria == 'none' %}selected{% endif %}>
                            {% if lang == 'fr' %}Sans cat√©gorie/Vari{% else %}Senza categoria/Vari{% endif %}
                        </option>
                    {% endif %}
                    {% for categoria in categorie %}
                        {% if categoria.id is not none %}
                            <option value="{{ categoria.id }}" {% if filters.categoria == categoria.id|string %}selected{% endif %}>
                                {{ categoria.nome }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">{% if lang == 'fr' %}Disponibilit√©{% else %}Disponibilit√†{% endif %}</label>
                <label class="checkbox">
                    <input type="checkbox" name="sotto_soglia" value="1" {% if filters.sotto_soglia %}checked{% endif %}>
                    <span>{% if lang == 'fr' %}Sous seuil{% else %}Sotto soglia{% endif %}</span>
                </label>
                <label class="checkbox">
                    <input type="checkbox" name="esauriti" value="1" {% if filters.esauriti %}checked{% endif %}>
                    <span>{% if lang == 'fr' %}√âpuis√©s{% else %}Solo esauriti{% endif %}</span>
                </label>
            </div>
            <div class="form-group">
                <label class="form-label">{% if lang == 'fr' %}Actions{% else %}Azioni{% endif %}</label>
                <div style="display: flex; gap: var(--space-2); align-items: center; flex-wrap: wrap;">
                    <button type="submit" class="btn btn-primary">
                        {% if lang == 'fr' %}Filtrer{% else %}Filtra{% endif %}
                    </button>
                    <a href="{{ url_for('capo_magazzino_list') }}" class="btn btn-secondary">
                        {% if lang == 'fr' %}R√©initialiser{% else %}Reset filtri{% endif %}
                    </a>
                </div>
            </div>
        </form>
        <div style="margin-top: var(--space-2); font-weight: 600;">
            {% if lang == 'fr' %}R√©sultats{% else %}Risultati{% endif %}: {{ items_count }}
        </div>
    </div>
</div>

{% if items_count == 0 %}
    <div class="card" style="margin-bottom: var(--space-3);">
        <div class="card-body">
            <p class="magazzino-item-desc">
                {% if lang == 'fr' %}
                    Aucun r√©sultat avec ces filtres.
                {% else %}
                    Nessun risultato con questi filtri.
                {% endif %}
            </p>
        </div>
    </div>
{% endif %}

{% for categoria in categorie %}
    {% set category_items = items_by_categoria.get(categoria.id, []) %}
    {% if category_items %}
        <section class="magazzino-category">
            <div class="magazzino-category-header">
                <h2>
                    {% if categoria.id == fallback_categoria.id %}
                        {% if lang == 'fr' %}Sans cat√©gorie/Vari{% else %}Senza categoria/Vari{% endif %}
                    {% else %}
                        {{ categoria.nome }}
                    {% endif %}
                </h2>
            </div>
            <div class="magazzino-items-grid">
                {% for item in category_items %}
                    {% set non_disponibile = item.quantita_disponibile is not none and item.quantita_disponibile <= 0 %}
                    {% set sotto_soglia = (not non_disponibile) and (item.soglia_minima is not none) and (item.quantita_disponibile is not none) and (item.quantita_disponibile < item.soglia_minima) %}
                    <div class="card magazzino-item-card">
                        <div class="card-body">
                            <div class="magazzino-item-header">
                                <h3>{{ item.nome }}</h3>
                                {% if non_disponibile %}
                                    <span class="badge badge-muted">{% if lang == 'fr' %}Indisponible{% else %}Non disponibile{% endif %}</span>
                                {% elif sotto_soglia %}
                                    <span class="badge badge-danger">{% if lang == 'fr' %}Sous seuil{% else %}Sotto soglia{% endif %}</span>
                                {% else %}
                                    <span class="badge badge-success">OK</span>
                                {% endif %}
                            </div>
                            <p class="magazzino-item-meta">
                                <strong>{% if lang == 'fr' %}Code{% else %}Codice{% endif %}:</strong>
                                {{ item.codice or '‚Äî' }}
                            </p>
                            <p class="magazzino-item-desc">{{ item.descrizione or '‚Äî' }}</p>
                            <div class="magazzino-item-stats">
                                <div>
                                    <span class="label">{% if lang == 'fr' %}Quantit√© disponible{% else %}Quantit√† disponibile{% endif %}</span>
                                    <span class="kpi-value">
                                        {% if item.quantita_disponibile is not none %}
                                            {{ item.quantita_disponibile }}
                                        {% else %}
                                            ‚Äî
                                        {% endif %}
                                    </span>
                                </div>
                                <div>
                                    <span class="label">{% if lang == 'fr' %}Seuil minimum{% else %}Soglia minima{% endif %}</span>
                                    <span class="value">{{ item.soglia_minima if item.soglia_minima is not none else '‚Äî' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </section>
    {% endif %}
{% endfor %}
{% endblock %}
