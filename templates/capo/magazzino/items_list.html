{% extends "shared/base.html" %}
{% set lang = request.cookies.get('lang', 'it') %}

{% block title %}
    {% if lang == 'fr' %}Magasin ‚Äì Chef d'√©quipe{% else %}Magazzino ‚Äì Caposquadra{% endif %}
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-main">
        <h1 class="page-title">üì¶ {% if lang == 'fr' %}Magasin{% else %}Magazzino{% endif %}</h1>
        <p class="page-subtitle">
            {% if lang == 'fr' %}
                Consultez les articles disponibles et leurs quantit√©s.
            {% else %}
                Consulta gli articoli disponibili e le quantit√† in magazzino.
            {% endif %}
        </p>
    </div>
    <div class="header-actions">
        <a href="{{ url_for('capo_magazzino_richieste') }}" class="btn btn-secondary">
            üìÑ {% if lang == 'fr' %}Mes demandes{% else %}Le mie richieste{% endif %}
        </a>
        <a href="{{ url_for('capo_magazzino_richiesta_new') }}" class="btn btn-primary">
            ‚ûï {% if lang == 'fr' %}Nouvelle demande{% else %}Nuova richiesta{% endif %}
        </a>
    </div>
</div>

{% set ok = request.query_params.get('ok') %}
{% set err = request.query_params.get('err') %}
{% if ok %}
    <div class="alert alert-success">
        {% if ok == 'carico' %}
            {% if lang == 'fr' %}Chargement enregistr√© avec succ√®s.{% else %}Carico registrato con successo.{% endif %}
        {% elif ok == 'scarico' %}
            {% if lang == 'fr' %}D√©chargement enregistr√© avec succ√®s.{% else %}Scarico registrato con successo.{% endif %}
        {% else %}
            {% if lang == 'fr' %}Op√©ration termin√©e avec succ√®s.{% else %}Operazione completata con successo.{% endif %}
        {% endif %}
    </div>
{% endif %}
{% if err %}
    <div class="alert alert-danger">
        {% if err == 'item_non_trovato' %}
            {% if lang == 'fr' %}Article introuvable.{% else %}Articolo non trovato.{% endif %}
        {% elif err == 'quantita_non_valida' %}
            {% if lang == 'fr' %}Quantit√© non valide.{% else %}Quantit√† non valida.{% endif %}
        {% elif err == 'quantita_insufficiente' %}
            {% if lang == 'fr' %}Quantit√© insuffisante en stock.{% else %}Quantit√† insufficiente in magazzino.{% endif %}
        {% else %}
            {% if lang == 'fr' %}Erreur lors de l'op√©ration.{% else %}Errore durante l'operazione.{% endif %}
        {% endif %}
    </div>
{% endif %}

<div class="card" style="margin-bottom: var(--space-3);">
    <div class="card-header">
        <div class="card-title">
            üîç {% if lang == 'fr' %}Filtres magasin{% else %}Filtri magazzino{% endif %}
        </div>
    </div>
    <div class="card-body">
        <form method="get" class="form-grid">
            <div class="form-group">
                <label for="search_q" class="form-label">
                    {% if lang == 'fr' %}Code ou nom{% else %}Codice o nome{% endif %}
                </label>
                <input type="text" id="search_q" name="q" class="form-control" value="{{ filters.q or '' }}">
            </div>
            <div class="form-group">
                <label for="categoria" class="form-label">
                    {% if lang == 'fr' %}Macro cat√©gorie{% else %}Macro categoria{% endif %}
                </label>
                <select id="categoria" name="categoria" class="form-select">
                    <option value="">{% if lang == 'fr' %}Toutes{% else %}Tutte{% endif %}</option>
                    {% if fallback_categoria.id is none %}
                        <option value="none" {% if filters.categoria == 'none' %}selected{% endif %}>
                            {% if lang == 'fr' %}Sans cat√©gorie{% else %}Senza categoria{% endif %}
                        </option>
                    {% endif %}
                    {% for categoria in categorie %}
                        {% if categoria.id is not none %}
                            <option value="{{ categoria.id }}" {% if filters.categoria == categoria.id|string %}selected{% endif %}>
                                {{ categoria.nome }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">{% if lang == 'fr' %}Disponibilit√©{% else %}Disponibilit√†{% endif %}</label>
                <label class="checkbox">
                    <input type="checkbox" name="sotto_soglia" value="1" {% if filters.sotto_soglia %}checked{% endif %}>
                    <span>{% if lang == 'fr' %}Sous seuil{% else %}Sotto soglia{% endif %}</span>
                </label>
                <label class="checkbox">
                    <input type="checkbox" name="esauriti" value="1" {% if filters.esauriti %}checked{% endif %}>
                    <span>{% if lang == 'fr' %}√âpuis√©s{% else %}Solo esauriti{% endif %}</span>
                </label>
            </div>
            <div class="form-group">
                <label class="form-label">{% if lang == 'fr' %}Actions{% else %}Azioni{% endif %}</label>
                <div style="display: flex; gap: var(--space-2); align-items: center; flex-wrap: wrap;">
                    <button type="submit" class="btn btn-primary">
                        {% if lang == 'fr' %}Filtrer{% else %}Filtra{% endif %}
                    </button>
                    <a href="{{ url_for('capo_magazzino_list') }}" class="btn btn-secondary">
                        {% if lang == 'fr' %}R√©initialiser{% else %}Reset filtri{% endif %}
                    </a>
                </div>
            </div>
        </form>
        <div style="margin-top: var(--space-2); font-weight: 600;">
            {% if lang == 'fr' %}R√©sultats{% else %}Risultati{% endif %}: {{ items_count }}
        </div>
    </div>
</div>

{% if items_count == 0 %}
    <div class="card" style="margin-bottom: var(--space-3);">
        <div class="card-body">
            <p class="magazzino-item-desc">
                {% if lang == 'fr' %}
                    Aucun r√©sultat avec ces filtres.
                {% else %}
                    Nessun risultato con questi filtri.
                {% endif %}
            </p>
        </div>
    </div>
{% endif %}

{% for section in categorie_sections %}
    {% set category_items = section.items %}
    {% if category_items %}
        <section class="magazzino-category">
            <div class="magazzino-category-header" style="display: flex; flex-direction: column; gap: var(--space-2);">
                <h2 style="display: flex; align-items: center; gap: var(--space-2);">
                    <span class="badge badge-{{ section.color }}" style="{{ section.color_style }}">
                        {{ section.icon }}
                    </span>
                    {% if section.cat.id == fallback_categoria.id %}
                        {% if lang == 'fr' %}Sans cat√©gorie{% else %}Senza categoria{% endif %}
                    {% else %}
                        {{ section.cat.nome }}
                    {% endif %}
                </h2>
                <div style="display: flex; gap: var(--space-3); flex-wrap: wrap; font-size: 0.85rem;">
                    <span><strong>{{ section.stats.total_items }}</strong> {% if lang == 'fr' %}articles{% else %}articoli{% endif %}</span>
                    <span><strong>{{ section.stats.sotto_soglia_count }}</strong> {% if lang == 'fr' %}sous seuil{% else %}sotto soglia{% endif %}</span>
                    <span><strong>{{ section.stats.esauriti_count }}</strong> {% if lang == 'fr' %}√©puis√©s{% else %}esauriti{% endif %}</span>
                </div>
            </div>
            <div class="magazzino-items-grid">
                {% for item in category_items %}
                    {% set esaurito = (item.quantita_disponibile is not none) and (item.quantita_disponibile <= 0) %}
                    {% set sotto_soglia = (not esaurito) and (item.soglia_minima is not none) and (item.quantita_disponibile is not none) and (item.quantita_disponibile <= item.soglia_minima) %}
                    <div class="card magazzino-item-card">
                        <div class="card-body">
                            <div class="magazzino-item-header">
                                <h3>{{ item.nome }}</h3>
                                {% if esaurito %}
                                    <span class="badge badge-danger">{% if lang == 'fr' %}√âpuis√©{% else %}Esaurito{% endif %}</span>
                                {% elif sotto_soglia %}
                                    <span class="badge badge-warning">{% if lang == 'fr' %}Sous seuil{% else %}Sotto soglia{% endif %}</span>
                                {% else %}
                                    <span class="badge badge-success">OK</span>
                                {% endif %}
                            </div>
                            <p class="magazzino-item-meta">
                                <strong>{% if lang == 'fr' %}Code{% else %}Codice{% endif %}:</strong>
                                {{ item.codice or '‚Äî' }}
                            </p>
                            <p class="magazzino-item-desc">{{ item.descrizione or '‚Äî' }}</p>
                            <div class="magazzino-item-stats">
                                <div class="magazzino-item-quantity">
                                    <span class="label">{% if lang == 'fr' %}Quantit√© disponible{% else %}Quantit√† disponibile{% endif %}</span>
                                    <span class="kpi-value">
                                        {% if item.quantita_disponibile is not none %}
                                            {{ item.quantita_disponibile }}
                                        {% else %}
                                            ‚Äî
                                        {% endif %}
                                    </span>
                                </div>
                                <div>
                                    <span class="label">{% if lang == 'fr' %}Seuil minimum{% else %}Soglia minima{% endif %}</span>
                                    <span class="value">{{ item.soglia_minima if item.soglia_minima is not none else '‚Äî' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </section>
    {% endif %}
{% endfor %}
{% endblock %}
