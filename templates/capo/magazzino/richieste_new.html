{% extends "shared/base.html" %}
{% set lang = request.cookies.get('lang', 'it') %}
{% set priorita_labels = {
    'LOW': 'Basse' if lang == 'fr' else 'Bassa',
    'MED': 'Moyenne' if lang == 'fr' else 'Media',
    'HIGH': 'Haute' if lang == 'fr' else 'Alta'
} %}

{% block title %}
    {% if lang == 'fr' %}Nouvelle demande ‚Äì Magasin{% else %}Nuova richiesta ‚Äì Magazzino{% endif %}
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-main">
        <p class="page-eyebrow">{% if lang == 'fr' %}Magasin{% else %}Magazzino{% endif %}</p>
        <h1 class="page-title">üìù {% if lang == 'fr' %}Nouvelle demande{% else %}Nuova richiesta{% endif %}</h1>
        <p class="page-subtitle">
            {% if lang == 'fr' %}
                S√©lectionnez les articles et les quantit√©s demand√©es.
            {% else %}
                Seleziona gli articoli e le quantit√† richieste.
            {% endif %}
        </p>
    </div>
    <div class="header-actions">
        <a href="{{ url_for('capo_magazzino_richieste') }}" class="btn btn-secondary">
            ‚Üê {% if lang == 'fr' %}Retour{% else %}Indietro{% endif %}
        </a>
    </div>
</div>

<form method="post">
    <div class="card table-card">
        <div class="card-body">
            <template id="item-options">
                <option value="">{% if lang == 'fr' %}S√©lectionner{% else %}Seleziona{% endif %}</option>
                {% for item in items %}
                    <option value="{{ item.id }}">{{ item.nome }}{% if item.codice %} - {{ item.codice }}{% endif %}</option>
                {% endfor %}
            </template>
            <table class="data-table" id="righe-table">
                <thead>
                    <tr>
                        <th>{% if lang == 'fr' %}Article{% else %}Articolo{% endif %}</th>
                        <th class="text-right">{% if lang == 'fr' %}Quantit√©{% else %}Quantit√†{% endif %}</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <select name="item_id" required>
                                <option value="">{% if lang == 'fr' %}S√©lectionner{% else %}Seleziona{% endif %}</option>
                                {% for item in items %}
                                    <option value="{{ item.id }}">{{ item.nome }}{% if item.codice %} - {{ item.codice }}{% endif %}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="text-right">
                            <input type="number" name="quantita" min="0" step="0.01" required>
                        </td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
            <div class="form-actions" style="margin-top: 16px;">
                <button type="button" class="btn btn-secondary" id="add-row">
                    ‚ûï {% if lang == 'fr' %}Ajouter une ligne{% else %}Aggiungi riga{% endif %}
                </button>
            </div>
        </div>
    </div>

    <div class="card large-form-card" style="margin-top: 16px;">
        <div class="card-body">
            <div class="form-grid-2">
                <div class="form-field">
                    <label>{% if lang == 'fr' %}Priorit√©{% else %}Priorit√†{% endif %}</label>
                    <select name="priorita">
                        {% for priorita in priorita_options %}
                            <option value="{{ priorita.value }}" {% if priorita.value == 'MED' %}selected{% endif %}>
                                {{ priorita_labels.get(priorita.value, priorita.value) }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-field">
                    <label>{% if lang == 'fr' %}Date n√©cessaire{% else %}Data necessaria{% endif %}</label>
                    <input type="date" name="data_necessaria">
                </div>
            </div>
            <div class="form-field">
                <label>{% if lang == 'fr' %}Notes{% else %}Note{% endif %}</label>
                <textarea name="note" placeholder="{% if lang == 'fr' %}Informations suppl√©mentaires{% else %}Indicazioni aggiuntive{% endif %}"></textarea>
            </div>

            <div class="form-actions">
                <a href="{{ url_for('capo_magazzino_richieste') }}" class="btn btn-secondary">
                    {% if lang == 'fr' %}Annuler{% else %}Annulla{% endif %}
                </a>
                <button type="submit" class="btn btn-primary">
                    {% if lang == 'fr' %}Envoyer{% else %}Invia richiesta{% endif %}
                </button>
            </div>
        </div>
    </div>
</form>

<script>
    const addRowButton = document.getElementById('add-row');
    const tableBody = document.querySelector('#righe-table tbody');
    const itemOptions = document.getElementById('item-options');
    if (addRowButton && tableBody && itemOptions) {
        addRowButton.addEventListener('click', () => {
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <select name="item_id" required>
                        ${itemOptions.innerHTML}
                    </select>
                </td>
                <td class="text-right">
                    <input type="number" name="quantita" min="0" step="0.01" required>
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm remove-row">üóëÔ∏è</button>
                </td>
            `;
            tableBody.appendChild(newRow);
        });

        tableBody.addEventListener('click', (event) => {
            const target = event.target;
            if (target && target.classList.contains('remove-row')) {
                target.closest('tr').remove();
            }
        });
    }
</script>
{% endblock %}
