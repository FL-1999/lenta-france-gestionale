{% extends "shared/base.html" %}

{% set lang = request.cookies.get('lang', 'it') %}

{% block title %}
    {% if lang == 'fr' %}
        Tableau de bord Chef d'équipe – Lenta France
    {% else %}
        Dashboard Caposquadra – Lenta France
    {% endif %}
{% endblock %}

{% block content %}
<div class="dashboard-page">
    <div class="page-header">
        <div class="page-header-main">
            <p class="page-eyebrow">
                {% if lang == 'fr' %}
                    Espace Chef d'équipe
                {% else %}
                    Area Caposquadra
                {% endif %}
            </p>

            <h1 class="page-title">
                {% if lang == 'fr' %}
                    Tableau de bord Chef d'équipe
                {% else %}
                    Dashboard Caposquadra
                {% endif %}
            </h1>

            <p class="page-subtitle">
                {% if lang == 'fr' %}
                    Vue d'ensemble des chantiers et des rapports de votre équipe.
                {% else %}
                    Panoramica dei cantieri e dei rapportini della tua squadra.
                {% endif %}
            </p>
        </div>
        <div class="header-actions">
            <a href="/capo/rapportini/nuovo" class="btn btn-lg btn-primary">
                {% if lang == 'fr' %}
                    Nouveau rapport
                {% else %}
                    Nuovo rapportino
                {% endif %}
            </a>
            <a href="/capo/rapportini" class="btn btn-lg btn-secondary">
                {% if lang == 'fr' %}
                    Mes rapports
                {% else %}
                    I miei rapportini
                {% endif %}
            </a>
            <a href="/capo/fiches/nuova" class="btn btn-lg btn-primary">
                {% if lang == 'fr' %}
                    Nouvelle fiche
                {% else %}
                    Nuova fiche
                {% endif %}
            </a>
        </div>
    </div>

    <div class="dashboard-kpi-grid">
        <div class="kpi-card kpi-accent-1">
            <div class="kpi-top">
                <div class="kpi-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="4.5" y="3.5" width="15" height="17" rx="2" ry="2" />
                        <path d="M8 8.5h8M8 12h8M8 15.5h5" stroke-linecap="round" />
                    </svg>
                </div>
                <span class="kpi-label">
                    {% if lang == 'fr' %}
                        Rapports d'aujourd'hui
                    {% else %}
                        Rapportini di oggi
                    {% endif %}
                </span>
            </div>
            <div class="kpi-value">{{ kpi_reports_today or 0 }}</div>
            <div class="kpi-sub">
                {% if lang == 'fr' %}
                    Rapports que vous avez complétés aujourd'hui.
                {% else %}
                    Rapportini che hai compilato oggi.
                {% endif %}
            </div>
        </div>

        <div class="kpi-card kpi-accent-2">
            <div class="kpi-top">
                <div class="kpi-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="7" />
                        <path d="M12 8v4l3 2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <span class="kpi-label">
                    {% if lang == 'fr' %}
                        Heures cette semaine
                    {% else %}
                        Ore questa settimana
                    {% endif %}
                </span>
            </div>
            <div class="kpi-value">{{ kpi_hours_this_week or 0 }}</div>
            <div class="kpi-sub">
                {% if lang == 'fr' %}
                    Heures travaillées depuis le début de la semaine.
                {% else %}
                    Ore lavorate dall'inizio della settimana.
                {% endif %}
            </div>
        </div>

        <div class="kpi-card kpi-accent-3">
            <div class="kpi-top">
                <div class="kpi-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 11.5L12 5l8 6.5V20H4z" stroke-linejoin="round" />
                        <path d="M10 20v-5h4v5" stroke-linecap="round" />
                    </svg>
                </div>
                <span class="kpi-label">
                    {% if lang == 'fr' %}
                        Chantiers assignés
                    {% else %}
                        Cantieri assegnati
                    {% endif %}
                </span>
            </div>
            <div class="kpi-value">{{ kpi_assigned_sites or 0 }}</div>
            <div class="kpi-sub">
                {% if lang == 'fr' %}
                    Chantiers dont vous êtes actuellement chef d'équipe.
                {% else %}
                    Cantieri su cui sei attualmente caposquadra.
                {% endif %}
            </div>
        </div>

        <div class="kpi-card kpi-accent-4">
            <div class="kpi-top">
                <div class="kpi-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 4a7 7 0 1 1 0 14 7 7 0 0 1 0-14Z" />
                        <path d="M12 8v4" stroke-linecap="round" />
                        <circle cx="12" cy="15.5" r="0.9" />
                    </svg>
                </div>
                <span class="kpi-label">
                    {% if lang == 'fr' %}
                        Rapports ouverts
                    {% else %}
                        Rapportini aperti
                    {% endif %}
                </span>
            </div>
            <div class="kpi-value">{{ kpi_open_reports or 0 }}</div>
            <div class="kpi-sub">
                {% if lang == 'fr' %}
                    Rapports à compléter ou à clôturer.
                {% else %}
                    Rapportini da completare o chiudere.
                {% endif %}
            </div>
        </div>
    </div>

    <div class="dashboard-modules-grid">
        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--reports" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="4.5" y="3.5" width="15" height="17" rx="2" ry="2" />
                            <path d="M8 8.5h8M8 12h8M8 15.5h5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>
                        {% if lang == 'fr' %}
                            Rapports
                        {% else %}
                            Rapportini
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <p>
                    {% if lang == 'fr' %}
                        Remplissez de nouveaux rapports de travail et consultez votre historique.
                    {% else %}
                        Compila nuovi rapportini di lavoro e consulta lo storico dei tuoi rapporti.
                    {% endif %}
                </p>
                <div class="card-actions">
                    <a href="/capo/rapportini/nuovo" class="btn btn-primary">
                        {% if lang == 'fr' %}
                            Nouveau rapport
                        {% else %}
                            Nuovo rapportino
                        {% endif %}
                    </a>
                    <a href="/capo/rapportini" class="btn btn-secondary">
                        {% if lang == 'fr' %}
                            Mes rapports
                        {% else %}
                            I miei rapportini
                        {% endif %}
                    </a>
                </div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--sites" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 11.5L12 5l8 6.5V20H4z" stroke-linejoin="round" />
                            <path d="M10 20v-5h4v5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>
                        {% if lang == 'fr' %}
                            Chantiers assignés
                        {% else %}
                            Cantieri assegnati
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <p>
                    {% if lang == 'fr' %}
                        Affichez les chantiers auxquels vous êtes assigné et les détails opérationnels.
                    {% else %}
                        Visualizza i cantieri a cui sei assegnato e i dettagli operativi.
                    {% endif %}
                </p>
                <div class="card-actions">
                    <a href="/capo/rapportini" class="btn btn-secondary">
                        {% if lang == 'fr' %}
                            Voir les chantiers
                        {% else %}
                            Vedi cantieri
                        {% endif %}
                    </a>
                </div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--fiches" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.5 4h7L17.5 7.5V20h-10V4z" stroke-linejoin="round" />
                            <path d="M14.5 4v4h4" stroke-linejoin="round" />
                            <path d="M9.5 11h5" stroke-linecap="round" />
                            <path d="M9.5 14h5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>
                        {% if lang == 'fr' %}
                            Fiches
                        {% else %}
                            Fiches
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <p>
                    {% if lang == 'fr' %}
                        Consultez les fiches liées à vos chantiers et rapports.
                    {% else %}
                        Consulta le fiches correlate ai tuoi cantieri e rapportini.
                    {% endif %}
                </p>
                <div class="card-actions">
                    <a href="/capo/fiches/nuova" class="btn btn-primary">
                        {% if lang == 'fr' %}
                            Nouvelle fiche
                        {% else %}
                            Nuova fiche
                        {% endif %}
                    </a>
                    <a href="/capo/fiches" class="btn btn-secondary">
                        {% if lang == 'fr' %}
                            Voir les fiches
                        {% else %}
                            Vedi fiches
                        {% endif %}
                    </a>
                </div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--users" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="9" cy="9" r="3" />
                            <circle cx="16" cy="10" r="2.5" />
                            <path d="M4.5 19.5c0-2.5 2.3-4.5 5.1-4.5h1.8c2.8 0 5.1 2 5.1 4.5" stroke-linecap="round" />
                            <path d="M15.4 12.8c2.2 0 4.1 1.6 4.1 3.7" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>
                        {% if lang == 'fr' %}
                            Votre profil
                        {% else %}
                            Il tuo profilo
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <p>
                    {% if lang == 'fr' %}
                        Récapitulatif de vos informations et activités récentes.
                    {% else %}
                        Riepilogo delle tue informazioni e attività recenti.
                    {% endif %}
                </p>
                <div class="card-actions">
                    <a href="/capo/dashboard" class="btn btn-secondary">
                        {% if lang == 'fr' %}
                            Aller au profil
                        {% else %}
                            Vai al profilo
                        {% endif %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="card dashboard-map-card">
        <div class="card-header">
            <div class="card-title">
                <div class="card-icon card-icon--sites" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 11.5L12 5l8 6.5V20H4z" stroke-linejoin="round" />
                        <path d="M10 20v-5h4v5" stroke-linecap="round" />
                    </svg>
                </div>
                <span>{% if lang == 'fr' %}Carte des chantiers{% else %}Mappa cantieri{% endif %}</span>
            </div>
        </div>
        <div class="card-body">
            {% if google_maps_api_key %}
                <div class="map-preview-actions">
                    <button type="button" class="btn btn-primary" data-cantieri-map-open>
                        {% if lang == 'fr' %}Ouvrir la carte{% else %}Apri mappa{% endif %}
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-cantieri-map-external>
                        {% if lang == 'fr' %}Ouvrir dans Google Maps{% else %}Apri in Google Maps{% endif %}
                    </button>
                </div>
                <div id="cantieri-map-wrapper" class="cantieri-map-wrapper">
                    <div id="cantieri-map" class="cantieri-map cantieri-map--preview" aria-label="{% if lang == 'fr' %}Carte des chantiers{% else %}Mappa cantieri{% endif %}"></div>
                </div>
            {% else %}
                <div class="map-disabled-message">
                    {% if lang == 'fr' %}
                        Carte désactivée (GOOGLE_MAPS_API_KEY manquant)
                    {% else %}
                        Mappa disattivata (manca GOOGLE_MAPS_API_KEY)
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>
<div class="map-modal" id="cantieri-map-modal" aria-hidden="true">
    <div class="map-modal__backdrop" data-cantieri-map-close></div>
    <div class="map-modal__panel" role="dialog" aria-modal="true">
        <div class="map-modal__header">
            <div class="map-modal__title">{% if lang == 'fr' %}Carte des chantiers{% else %}Mappa cantieri{% endif %}</div>
            <div class="map-modal__actions">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-cantieri-map-external>
                    {% if lang == 'fr' %}Ouvrir dans Google Maps{% else %}Apri in Google Maps{% endif %}
                </button>
                <button type="button" class="btn btn-secondary btn-sm" data-cantieri-map-close>✖</button>
            </div>
        </div>
        <div id="cantieri-map-modal-body" class="map-modal__body"></div>
    </div>
</div>
{% if google_maps_api_key %}
{% set enable_clustering = true %}
<script type="application/json" id="cantieri-map-config">
  {{ {
    "sites": cantieri_map_data,
    "detailUrlTemplate": detail_url_template,
    "coloredMarkers": true,
    "clustering": enable_clustering,
    "filters": false
  } | tojson | safe }}
</script>
{% if enable_clustering %}
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
{% endif %}
<script src="{{ url_for('static', path='/js/cantieri-map.js') }}"></script>
<script src="{{ url_for('static', path='/js/cantieri-map-modal.js') }}"></script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"></script>
{% endif %}
{% endblock %}
