{% extends "shared/base.html" %}

{% block title %}Nuovo Rapportino – Caposquadra{% endblock %}

{% block content %}
<div class="form-page">
    <div class="form-page-header">
        <p class="eyebrow">Area Caposquadra</p>
        <h1 class="page-title">
            <span class="page-icon page-icon--reports" aria-hidden="true"></span>
            Nuovo rapportino giornaliero
        </h1>
        <p class="subtitle">
            Compila il rapportino della giornata per il cantiere selezionato. I dati verranno inviati
            al backend tramite l'API <code>POST /reports</code>.
        </p>
    </div>

    <div class="card form-card">
        <div class="card-header">
            <div class="card-title">
                <span>Dettagli rapportino</span>
            </div>
        </div>
        <div class="card-body">
            <form id="rapportino-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="data">Data</label>
                        <input type="date" id="data" name="data" class="form-control" required />
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cantiere">Cantiere</label>
                        <input type="text" id="cantiere" name="cantiere" class="form-control" required placeholder="Nome o codice cantiere" />
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="ore_totali">Ore totali lavorate</label>
                        <input type="number" id="ore_totali" name="ore_totali" class="form-control" min="0" step="0.5" required placeholder="es. 8" />
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="numero_operai">Numero operai</label>
                        <input type="number" id="numero_operai" name="numero_operai" class="form-control" min="0" required placeholder="es. 3" />
                    </div>
                </div>

                <div class="form-group form-grid form-grid--single">
                    <div class="form-group">
                        <label class="form-label" for="macchinari">Macchinari utilizzati</label>
                        <textarea id="macchinari" name="macchinari" class="form-textarea" rows="2"
                                  placeholder="Es. Escavatore 20t, Minipala, Furgone..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="attivita">Attività svolte</label>
                        <textarea id="attivita" name="attivita" class="form-textarea" rows="4"
                                  placeholder="Descrivi brevemente le attività eseguite in giornata."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="note">Note aggiuntive</label>
                        <textarea id="note" name="note" class="form-textarea" rows="3"
                                  placeholder="Eventuali problemi, ritardi, materiali mancanti, ecc."></textarea>
                    </div>
                </div>

                <div id="rapportino-error" class="form-error" style="display:none;"></div>
                <div id="rapportino-success" class="form-help" style="display:none;"></div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Salva rapportino</button>
                    <a href="/capo/dashboard" class="btn btn-secondary">Torna alla dashboard</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById("rapportino-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const data = document.getElementById("data").value;
    const cantiere = (document.getElementById("cantiere").value || "").trim();
    const ore_totali = parseFloat(document.getElementById("ore_totali").value || "0");
    const numero_operai = parseInt(document.getElementById("numero_operai").value || "0", 10);
    const macchinari = (document.getElementById("macchinari").value || "").trim();
    const attivita = (document.getElementById("attivita").value || "").trim();
    const note = (document.getElementById("note").value || "").trim();

    const errorBox = document.getElementById("rapportino-error");
    const successBox = document.getElementById("rapportino-success");

    errorBox.style.display = "none";
    errorBox.textContent = "";
    successBox.style.display = "none";
    successBox.textContent = "";

    if (!data || !cantiere) {
        errorBox.textContent = "Data e cantiere sono obbligatori.";
        errorBox.style.display = "block";
        return;
    }

    // Recupera il token dal localStorage
    let token = null;
    try {
        token = localStorage.getItem("lf_token");
    } catch (e) {
        console.error("Impossibile leggere lf_token:", e);
    }

    if (!token) {
        errorBox.textContent = "Nessun token trovato. Effettua di nuovo il login.";
        errorBox.style.display = "block";
        return;
    }

    const payload = {
        date: data,
        site_name_or_code: cantiere,
        total_hours: ore_totali,
        workers_count: numero_operai,
        machines_used: macchinari,
        activities: attivita,
        notes: note,
    };

    try {
        const resp = await fetch("/reports", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token,
            },
            body: JSON.stringify(payload),
        });

        if (!resp.ok) {
            if (resp.status === 401 || resp.status === 403) {
                errorBox.textContent = "Non sei autorizzato a creare rapportini. Effettua di nuovo il login.";
            } else if (resp.status === 422) {
                errorBox.textContent = "Dati non validi (errore di validazione). Controlla i campi e riprova.";
            } else {
                errorBox.textContent = "Errore nel salvataggio del rapportino. Codice: " + resp.status;
            }
            errorBox.style.display = "block";
            return;
        }

        const dataResp = await resp.json();
        console.log("Rapportino salvato:", dataResp);

        successBox.textContent = "Rapportino salvato con successo!";
        successBox.style.display = "block";

        // Se vuoi, svuota il form dopo il salvataggio
        document.getElementById("rapportino-form").reset();
    } catch (err) {
        console.error(err);
        errorBox.textContent = "Errore di connessione al server durante il salvataggio del rapportino.";
        errorBox.style.display = "block";
    }
});
</script>
{% endblock %}
