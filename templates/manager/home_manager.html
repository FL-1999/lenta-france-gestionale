{% extends "base.html" %}

{% set lang = request.cookies.get('lang', 'it') %}

{% block title %}
    {% if lang == 'fr' %}
        Tableau de bord Manager â€“ Lenta France
    {% else %}
        Dashboard Manager â€“ Lenta France
    {% endif %}
{% endblock %}

{% block content %}
<div class="dashboard-page">
    <div class="page-header dashboard-header">
        <div>
            <p class="eyebrow">
                {% if lang == 'fr' %}
                    Espace Manager
                {% else %}
                    Pannello Manager
                {% endif %}
            </p>
            <h1>
                {% if lang == 'fr' %}
                    Tableau de bord Manager
                {% else %}
                    Dashboard Manager
                {% endif %}
            </h1>
            <p>
                {% if lang == 'fr' %}
                    Bienvenue{{ ' ' + user.full_name if user and user.full_name else '' }}, ici vous trouvez le rÃ©capitulatif des rapports enregistrÃ©s et les raccourcis pour la gestion.
                {% else %}
                    Benvenuto{{ ' ' + user.full_name if user and user.full_name else '' }}, qui trovi il riepilogo dei rapportini salvati e le scorciatoie per la gestione.
                {% endif %}
            </p>
        </div>
        <div class="header-actions dashboard-actions">
            <a href="/capo/rapportini/nuovo" class="btn btn-lg btn-primary">âž• {% if lang == 'fr' %}Nouveau rapport{% else %}Nuovo rapportino{% endif %}</a>
            <a href="/manager/rapportini" class="btn btn-lg btn-secondary">{% if lang == 'fr' %}Liste des rapports{% else %}Elenco rapportini{% endif %}</a>
            <a href="{{ url_for('manager_fiche_new_form') }}" class="btn btn-lg btn-primary">
                ðŸ“„ {% if lang == 'fr' %}Nouvelle fiche{% else %}Nuova fiche{% endif %}
            </a>
            <a href="/manager/fiches" class="btn btn-lg btn-secondary">{% if lang == 'fr' %}Voir fiches{% else %}Vedi fiches{% endif %}</a>
        </div>
    </div>

    {% set rapportini_totali = reports_count|default(rapportini_count|default('â€”')) %}
    {% set cantieri_totali = sites_count|default(cantieri_count|default('â€”')) %}
    {% set macchinari_totali = macchinari_count|default(machines_count|default('â€”')) %}
    {% set utenti_totali = users_count|default('â€”') %}

    <div class="dashboard-kpi-grid">
        <div class="kpi-card kpi-accent-1">
            <div class="kpi-top">
                <div class="card-icon card-icon--reports" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="4.5" y="3.5" width="15" height="17" rx="2" ry="2" />
                        <path d="M8 8.5h8M8 12h8M8 15.5h5" stroke-linecap="round" />
                    </svg>
                </div>
                <span class="kpi-label">{% if lang == 'fr' %}Rapports totaux{% else %}Rapportini totali{% endif %}</span>
            </div>
            <div class="kpi-value">{{ rapportini_totali }}</div>
            <div class="kpi-sub">{% if lang == 'fr' %}Mis Ã  jour quotidiennement{% else %}Aggiornato giornalmente{% endif %}</div>
        </div>

        <div class="kpi-card kpi-accent-2">
            <div class="kpi-top">
                <div class="card-icon card-icon--sites" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 11.5L12 5l8 6.5V20H4z" stroke-linejoin="round" />
                        <path d="M10 20v-5h4v5" stroke-linecap="round" />
                    </svg>
                </div>
                <span class="kpi-label">{% if lang == 'fr' %}Chantiers actifs{% else %}Cantieri attivi{% endif %}</span>
            </div>
            <div class="kpi-value">{{ cantieri_totali }}</div>
            <div class="kpi-sub">{% if lang == 'fr' %}En cours{% else %}In lavorazione{% endif %}</div>
        </div>

        <div class="kpi-card kpi-accent-3">
            <div class="kpi-top">
                <div class="card-icon card-icon--machines" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="7" />
                        <path d="M12 8.5v-2M12 17.5v-2M15.5 12h2M6.5 12h2M14.95 9.05l1.35-1.35M7.7 16.3l1.35-1.35M9.05 9.05 7.7 7.7M16.3 16.3l-1.35-1.35" stroke-linecap="round" />
                        <circle cx="12" cy="12" r="2.3" />
                    </svg>
                </div>
                <span class="kpi-label">{% if lang == 'fr' %}Machines disponibles{% else %}Macchinari disponibili{% endif %}</span>
            </div>
            <div class="kpi-value">{{ macchinari_totali }}</div>
            <div class="kpi-sub">{% if lang == 'fr' %}Parc machines{% else %}Parco mezzi{% endif %}</div>
        </div>

        <div class="kpi-card kpi-accent-4">
            <div class="kpi-top">
                <div class="card-icon card-icon--users" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="9" cy="9" r="3" />
                        <circle cx="16" cy="10" r="2.5" />
                        <path d="M4.5 19.5c0-2.5 2.3-4.5 5.1-4.5h1.8c2.8 0 5.1 2 5.1 4.5" stroke-linecap="round" />
                        <path d="M15.4 12.8c2.2 0 4.1 1.6 4.1 3.7" stroke-linecap="round" />
                    </svg>
                </div>
                <span class="kpi-label">{% if lang == 'fr' %}Utilisateurs inscrits{% else %}Utenti registrati{% endif %}</span>
            </div>
            <div class="kpi-value">{{ utenti_totali }}</div>
            <div class="kpi-sub">{% if lang == 'fr' %}Managers et chefs d'Ã©quipe{% else %}Manager e capisquadra{% endif %}</div>
        </div>
    </div>

    {% set trend_counts = rapportini_trend|default(reports_trend|default([5, 7, 4, 6, 5, 8, 6])) %}
    {% set max_trend = trend_counts|max if trend_counts else 1 %}

    <div class="dashboard-modules-grid">
        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--sites" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 11.5L12 5l8 6.5V20H4z" stroke-linejoin="round" />
                            <path d="M10 20v-5h4v5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}Chantiers{% else %}Cantieri{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <p>{% if lang == 'fr' %}Surveillez l'avancement des chantiers, gÃ©rez les dÃ©tails et l'assignation des Ã©quipes.{% else %}Monitora l'avanzamento dei cantieri, gestisci dettagli e assegnazioni delle squadre.{% endif %}</p>
            <div class="card-actions">
                <a href="/manager/cantieri" class="btn btn-secondary">{% if lang == 'fr' %}Liste des chantiers{% else %}Lista cantieri{% endif %}</a>
                <a href="/manager/cantieri/nuovo" class="btn btn-primary">âž• {% if lang == 'fr' %}Nouveau chantier{% else %}Nuovo cantiere{% endif %}</a>
            </div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--machines" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="7" />
                            <path d="M12 8.5v-2M12 17.5v-2M15.5 12h2M6.5 12h2M14.95 9.05l1.35-1.35M7.7 16.3l1.35-1.35M9.05 9.05 7.7 7.7M16.3 16.3l-1.35-1.35" stroke-linecap="round" />
                            <circle cx="12" cy="12" r="2.3" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}Machines{% else %}Macchinari{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <p>{% if lang == 'fr' %}GÃ©rez le parc machines, leur Ã©tat et les affectations aux chantiers en cours.{% else %}Gestisci il parco macchinari, lo stato e le assegnazioni ai cantieri in corso.{% endif %}</p>
            <div class="card-actions">
                <a href="{{ request.url_for('manager_machines_list') }}" class="btn btn-secondary">{% if lang == 'fr' %}Liste des machines{% else %}Lista macchinari{% endif %}</a>
                <a href="{{ request.url_for('new_machine_form') }}" class="btn btn-primary">ðŸ›  {% if lang == 'fr' %}Nouveau macchinario{% else %}Nuovo macchinario{% endif %}</a>
            </div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--fiches" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.5 4h7L17.5 7.5V20h-10V4z" stroke-linejoin="round" />
                            <path d="M14.5 4v4h4" stroke-linejoin="round" />
                            <path d="M9.5 11h5" stroke-linecap="round" />
                            <path d="M9.5 14h5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}Fiches{% else %}Fiches{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <p>{% if lang == 'fr' %}Consultez et filtrez les fiches saisies par les chefs d'Ã©quipe pour une vue rapide des activitÃ©s.{% else %}Consulta e filtra le fiches inserite dai capisquadra per avere una vista rapida delle attivitÃ .{% endif %}</p>
            <div class="card-actions">
                <a href="/manager/fiches" class="btn btn-secondary">{% if lang == 'fr' %}Voir fiches{% else %}Vedi fiches{% endif %}</a>
                <a href="{{ url_for('manager_fiche_new_form') }}" class="btn btn-primary">âž• {% if lang == 'fr' %}Nouvelle fiche{% else %}Nuova fiche{% endif %}</a>
            </div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--reports" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="4.5" y="3.5" width="15" height="17" rx="2" ry="2" />
                            <path d="M8 8.5h8M8 12h8M8 15.5h5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}Rapports{% else %}Rapportini{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <p>{% if lang == 'fr' %}Consultez, filtrez et analysez tous les rapports envoyÃ©s par les chefs d'Ã©quipe.{% else %}Consulta, filtra e approfondisci tutti i rapportini inviati dai capisquadra.{% endif %}</p>
            <div class="card-actions">
                <a href="/manager/rapportini" class="btn btn-secondary">{% if lang == 'fr' %}Aller Ã  la liste des rapports{% else %}Vai all'elenco rapportini{% endif %}</a>
            </div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--users" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="9" cy="9" r="3" />
                            <circle cx="16" cy="10" r="2.5" />
                            <path d="M4.5 19.5c0-2.5 2.3-4.5 5.1-4.5h1.8c2.8 0 5.1 2 5.1 4.5" stroke-linecap="round" />
                            <path d="M15.4 12.8c2.2 0 4.1 1.6 4.1 3.7" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}Utilisateurs{% else %}Utenti{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <p>{% if lang == 'fr' %}GÃ©rez les utilisateurs, crÃ©ez de nouveaux chefs d'Ã©quipe et modifiez les rÃ´les selon les besoins opÃ©rationnels.{% else %}Gestisci gli utenti, crea nuovi capisquadra e modifica i ruoli in base alle necessitÃ  operative.{% endif %}</p>
            <div class="card-actions">
                <a href="/manager/utenti" class="btn btn-secondary">{% if lang == 'fr' %}Liste des utilisateurs{% else %}Lista utenti{% endif %}</a>
                <a href="/manager/utenti/nuovo" class="btn btn-primary">âž• {% if lang == 'fr' %}Nouvel utilisateur{% else %}Nuovo utente{% endif %}</a>
            </div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--activity" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="5" y="4" width="6" height="6" rx="1.2" />
                            <rect x="13" y="4" width="6" height="6" rx="1.2" />
                            <rect x="5" y="12" width="6" height="8" rx="1.2" />
                            <rect x="13" y="12" width="6" height="8" rx="1.2" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}ActivitÃ© rÃ©cente{% else %}AttivitÃ  recente{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <p>{% if lang == 'fr' %}Tendance hebdomadaire des envois de rapports.{% else %}Andamento settimanale degli invii dei rapportini.{% endif %}</p>
                <div class="mini-chart" role="img" aria-label="{% if lang == 'fr' %}Tendance des rapports{% else %}Trend rapportini{% endif %}">
                    <svg width="100%" height="50" viewBox="0 0 {{ 20 * (trend_counts|length) }} 50" preserveAspectRatio="none">
                        {% for value in trend_counts %}
                            {% set bar_height = (value / (max_trend or 1)) * 40 %}
                            <rect x="{{ loop.index0 * 20 + 2 }}" y="{{ 46 - bar_height }}" width="14" height="{{ bar_height }}" rx="3" class="trend-bar" />
                        {% endfor %}
                        {% if not trend_counts %}
                            <text x="4" y="30" fill="currentColor" opacity="0.6">{% if lang == 'fr' %}Aucune donnÃ©e{% else %}Nessun dato{% endif %}</text>
                        {% endif %}
                    </svg>
                </div>
                <div class="card-actions">
                    <a href="/manager/rapportini" class="btn btn-secondary btn-sm">{% if lang == 'fr' %}DÃ©tails des rapports{% else %}Dettagli rapportini{% endif %}</a>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-analytics-grid">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--reports" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="4.5" y="3.5" width="15" height="17" rx="2" ry="2" />
                            <path d="M8 8.5h8M8 12h8M8 15.5h5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}Rapports des 30 derniers jours{% else %}Rapportini ultimi 30 giorni{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <canvas id="chartReportsLast30Days"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--sites" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 11.5L12 5l8 6.5V20H4z" stroke-linejoin="round" />
                            <path d="M10 20v-5h4v5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}Heures par chantier (30 jours){% else %}Ore per cantiere (30 giorni){% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <canvas id="chartHoursPerSite"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--reports" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="4.5" y="3.5" width="15" height="17" rx="2" ry="2" />
                            <path d="M8 8.5h8M8 12h8M8 15.5h5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}Statut des rapports{% else %}Stato rapportini{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <canvas id="chartReportsByStatus"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    window.managerDashboardData = {
        reportsLast30Days: {{ chart_reports_last_30_days | tojson | safe }},
        hoursPerSite30Days: {{ chart_hours_per_site_30_days | tojson | safe }},
        reportsByStatus: {{ chart_reports_by_status | tojson | safe }}
    };
</script>
<script src="{{ url_for('static', path='/js/manager_dashboard_charts.js') }}"></script>
{% endblock %}
