{% extends "base.html" %}
{% set lang = request.cookies.get('lang', 'it') %}
{% block title %}
    {% if lang == 'fr' %}
        Tableau de bord Manager ‚Äì Lenta France
    {% else %}
        Dashboard Manager ‚Äì Lenta France
    {% endif %}
{% endblock %}
{% block content %}
<div class="dashboard-page">
    <div class="page-header dashboard-header">
        <div>
            <p class="eyebrow">
                {% if lang == 'fr' %}
                    Espace Manager
                {% else %}
                    Pannello Manager
                {% endif %}
            </p>
            <h1>
                {% if lang == 'fr' %}
                    Tableau de bord Manager
                {% else %}
                    Dashboard Manager
                {% endif %}
            </h1>
            <p>
                {% if lang == 'fr' %}
                    Bienvenue{{ ' ' + user.full_name if user and user.full_name else '' }}, ici vous trouvez le r√©capitulatif des rapports enregistr√©s et les raccourcis pour la gestion.
                {% else %}
                    Benvenuto{{ ' ' + user.full_name if user and user.full_name else '' }}, qui trovi il riepilogo dei rapportini salvati e le scorciatoie per la gestione.
                {% endif %}
            </p>
        </div>
        <div class="header-actions dashboard-actions">
            <a href="/capo/rapportini/nuovo" class="btn btn-lg btn-primary">
                ‚ûï {% if lang == 'fr' %}Nouveau rapport{% else %}Nuovo rapportino{% endif %}
            </a>
            <a href="/manager/rapportini" class="btn btn-lg btn-secondary">
                {% if lang == 'fr' %}Liste des rapports{% else %}Elenco rapportini{% endif %}
            </a>
            <a href="{{ url_for('manager_fiche_new_form') }}" class="btn btn-lg btn-primary">
                üìÑ {% if lang == 'fr' %}Nouvelle fiche{% else %}Nuova fiche{% endif %}
            </a>
            <a href="/manager/fiches" class="btn btn-lg btn-secondary">
                {% if lang == 'fr' %}Voir fiches{% else %}Vedi fiches{% endif %}
            </a>
        </div>
    </div>

    {% set nuove_richieste = nuove_richieste_count|default(0) %}
    {% set badge_text = '99+' if nuove_richieste > 99 else nuove_richieste %}

    <div class="dashboard-shortcuts">
        <div class="section-header">
            <h2>{% if lang == 'fr' %}Raccourcis{% else %}Scorciatoie{% endif %}</h2>
            <p>
                {% if lang == 'fr' %}
                    Acc√®s rapide aux fonctionnalit√©s cl√©s du Magazzino.
                {% else %}
                    Accesso rapido alle funzioni principali del Magazzino.
                {% endif %}
            </p>
        </div>
        <div class="shortcut-grid">
            <div class="card shortcut-card">
                <a class="shortcut-card-link" href="/manager/magazzino" aria-label="Apri Magazzino"></a>
                {% if nuove_richieste > 0 %}
                    <span class="shortcut-badge">{{ badge_text }}</span>
                {% endif %}
                <div class="shortcut-body">
                    <div class="shortcut-title">üì¶ Magazzino</div>
                    <div class="shortcut-subtitle">
                        {% if lang == 'fr' %}
                            G√©rez les articles et les demandes.
                        {% else %}
                            Gestisci articoli e richieste.
                        {% endif %}
                    </div>
                    {% if nuove_richieste > 0 %}
                        <div class="shortcut-line">
                            {% if lang == 'fr' %}Nouvelles demandes{% else %}Richieste nuove{% endif %}: {{ nuove_richieste }}
                        </div>
                    {% endif %}
                    <div class="shortcut-links">
                        <a class="shortcut-link" href="{{ request.url_for('manager_magazzino_list') }}">
                            {% if lang == 'fr' %}Ouvrir Magazzino{% else %}Apri Magazzino{% endif %}
                        </a>
                        <a class="shortcut-link" href="{{ request.url_for('manager_magazzino_richieste') }}">
                            {% if lang == 'fr' %}Ouvrir demandes{% else %}Apri Richieste{% endif %}
                        </a>
                    </div>
                    <div class="shortcut-quick-links">
                        <span class="shortcut-quick-label">
                            {% if lang == 'fr' %}Liens rapides:{% else %}Link rapidi:{% endif %}
                        </span>
                        <a class="shortcut-link" href="{{ request.url_for('manager_magazzino_richieste') }}">
                            {% if lang == 'fr' %}Demandes{% else %}Richieste{% endif %}
                        </a>
                        <a class="shortcut-link" href="{{ request.url_for('manager_magazzino_movimenti') }}">
                            {% if lang == 'fr' %}Mouvements{% else %}Movimenti{% endif %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% set rapportini_totali = reports_count|default(rapportini_count|default('‚Äî')) %}
    {% set cantieri_totali = sites_count|default(cantieri_count|default('‚Äî')) %}
    {% set macchinari_totali = macchinari_count|default(machines_count|default('‚Äî')) %}
    {% set utenti_totali = users_count|default('‚Äî') %}

    <div class="dashboard-kpi-grid">
        <div class="kpi-card kpi-accent-1">
            <div class="kpi-top">
                <div class="card-icon card-icon--reports" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="4.5" y="3.5" width="15" height="17" rx="2" ry="2" />
                        <path d="M8 8.5h8M8 12h8M8 15.5h5" stroke-linecap="round" />
                    </svg>
                </div>
                <span class="kpi-label">
                    {% if lang == 'fr' %}Rapports totaux{% else %}Rapportini totali{% endif %}
                </span>
            </div>
            <div class="kpi-value">{{ rapportini_totali }}</div>
            <div class="kpi-sub">
                {% if lang == 'fr' %}Mis √† jour quotidiennement{% else %}Aggiornato giornalmente{% endif %}
            </div>
        </div>

        <div class="kpi-card kpi-accent-2">
            <div class="kpi-top">
                <div class="card-icon card-icon--sites" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 11.5L12 5l8 6.5V20H4z" stroke-linejoin="round" />
                        <path d="M10 20v-5h4v5" stroke-linecap="round" />
                    </svg>
                </div>
                <span class="kpi-label">
                    {% if lang == 'fr' %}Chantiers actifs{% else %}Cantieri attivi{% endif %}
                </span>
            </div>
            <div class="kpi-value">{{ cantieri_totali }}</div>
            <div class="kpi-sub">
                {% if lang == 'fr' %}En cours{% else %}In lavorazione{% endif %}
            </div>
        </div>

        <div class="kpi-card kpi-accent-3">
            <div class="kpi-top">
                <div class="card-icon card-icon--machines" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="7" />
                        <path d="M12 8.5v-2M12 17.5v-2M15.5 12h2M6.5 12h2M14.95 9.05l1.35-1.35M7.7 16.3l1.35-1.35M9.05 9.05 7.7 7.7M16.3 16.3l-1.35-1.35" stroke-linecap="round" />
                        <circle cx="12" cy="12" r="2.3" />
                    </svg>
                </div>
                <span class="kpi-label">
                    {% if lang == 'fr' %}Machines disponibles{% else %}Macchinari disponibili{% endif %}
                </span>
            </div>
            <div class="kpi-value">{{ macchinari_totali }}</div>
            <div class="kpi-sub">
                {% if lang == 'fr' %}Parc machines{% else %}Parco mezzi{% endif %}
            </div>
        </div>

        <div class="kpi-card kpi-accent-4">
            <div class="kpi-top">
                <div class="card-icon card-icon--users" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="9" cy="9" r="3" />
                        <circle cx="16" cy="10" r="2.5" />
                        <path d="M4.5 19.5c0-2.5 2.3-4.5 5.1-4.5h1.8c2.8 0 5.1 2 5.1 4.5" stroke-linecap="round" />
                        <path d="M15.4 12.8c2.2 0 4.1 1.6 4.1 3.7" stroke-linecap="round" />
                    </svg>
                </div>
                <span class="kpi-label">
                    {% if lang == 'fr' %}Utilisateurs inscrits{% else %}Utenti registrati{% endif %}
                </span>
            </div>
            <div class="kpi-value">{{ utenti_totali }}</div>
            <div class="kpi-sub">
                {% if lang == 'fr' %}Managers et chefs d'√©quipe{% else %}Manager e capisquadra{% endif %}
            </div>
        </div>
    </div>

    {% set trend_counts = rapportini_trend|default(reports_trend|default([5, 7, 4, 6, 5, 8, 6])) %}
    {% set max_trend = trend_counts|max if trend_counts else 1 %}

    <div class="dashboard-modules-grid">
        <!-- Cantieri -->
        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--sites" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 11.5L12 5l8 6.5V20H4z" stroke-linejoin="round" />
                            <path d="M10 20v-5h4v5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}Chantiers{% else %}Cantieri{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <p>
                    {% if lang == 'fr' %}
                        Surveillez l'avancement des chantiers, g√©rez les d√©tails et l'assignation des √©quipes.
                    {% else %}
                        Monitora l'avanzamento dei cantieri, gestisci dettagli e assegnazioni delle squadre.
                    {% endif %}
                </p>
                <div class="card-actions">
                    <a href="/manager/cantieri" class="btn btn-secondary">
                        {% if lang == 'fr' %}Liste des chantiers{% else %}Lista cantieri{% endif %}
                    </a>
                    <a href="/manager/cantieri/nuovo" class="btn btn-primary">
                        ‚ûï {% if lang == 'fr' %}Nouveau chantier{% else %}Nuovo cantiere{% endif %}
                    </a>
                </div>
            </div>
        </div>

        <!-- Macchinari -->
        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--machines" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="7" />
                            <path d="M12 8.5v-2M12 17.5v-2M15.5 12h2M6.5 12h2M14.95 9.05l1.35-1.35M7.7 16.3l1.35-1.35M9.05 9.05 7.7 7.7M16.3 16.3l-1.35-1.35" stroke-linecap="round" />
                            <circle cx="12" cy="12" r="2.3" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}Machines{% else %}Macchinari{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <p>
                    {% if lang == 'fr' %}
                        G√©rez le parc machines, leur √©tat et les affectations aux chantiers en cours.
                    {% else %}
                        Gestisci il parco macchinari, lo stato e le assegnazioni ai cantieri in corso.
                    {% endif %}
                </p>
                <div class="card-actions">
                    <a href="{{ request.url_for('manager_machines_list') }}" class="btn btn-secondary">
                        {% if lang == 'fr' %}Liste des machines{% else %}Lista macchinari{% endif %}
                    </a>
                    <a href="{{ request.url_for('new_machine_form') }}" class="btn btn-primary">
                        üõ† {% if lang == 'fr' %}Nouveau macchinario{% else %}Nuovo macchinario{% endif %}
                    </a>
                </div>
            </div>
        </div>

        <!-- Veicoli -->
        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--machines" aria-hidden="true">
                        <!-- Riutilizzo stile macchinari, ma puoi cambiare l‚ÄôSVG se vuoi un‚Äôicona diversa -->
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="9" width="13" height="7" rx="1.5" />
                            <path d="M16 11h2.5a1.5 1.5 0 0 1 1.5 1.5V16h-2" stroke-linecap="round" />
                            <circle cx="7.5" cy="17" r="1.6" />
                            <circle cx="15.5" cy="17" r="1.6" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}V√©hicules{% else %}Veicoli{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <p>
                    {% if lang == 'fr' %}
                        G√©rez les v√©hicules aziendali, plaques, kilom√©trage et notes.
                    {% else %}
                        Gestisci i veicoli aziendali, targhe, chilometraggio e note.
                    {% endif %}
                </p>
                <div class="card-actions">
                    <a href="{{ url_for('manager_veicoli_list') }}" class="btn btn-secondary">
                        üöê {% if lang == 'fr' %}Liste des v√©hicules{% else %}Lista veicoli{% endif %}
                    </a>
                    <a href="{{ url_for('manager_veicoli_new') }}" class="btn btn-primary">
                        ‚ûï {% if lang == 'fr' %}Nouveau v√©hicule{% else %}Nuovo veicolo{% endif %}
                    </a>
                </div>
            </div>
        </div>

        <!-- Fiches -->
        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--fiches" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.5 4h7L17.5 7.5V20h-10V4z" stroke-linejoin="round" />
                            <path d="M14.5 4v4h4" stroke-linejoin="round" />
                            <path d="M9.5 11h5" stroke-linecap="round" />
                            <path d="M9.5 14h5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}Fiches{% else %}Fiches{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <p>
                    {% if lang == 'fr' %}
                        Consultez et filtrez les fiches saisies par les chefs d'√©quipe pour une vue rapide des activit√©s.
                    {% else %}
                        Consulta e filtra le fiches inserite dai capisquadra per avere una vista rapida delle attivit√†.
                    {% endif %}
                </p>
                <div class="card-actions">
                    <a href="/manager/fiches" class="btn btn-secondary">
                        {% if lang == 'fr' %}Voir fiches{% else %}Vedi fiches{% endif %}
                    </a>
                    <a href="{{ url_for('manager_fiche_new_form') }}" class="btn btn-primary">
                        ‚ûï {% if lang == 'fr' %}Nouvelle fiche{% else %}Nuova fiche{% endif %}
                    </a>
                </div>
            </div>
        </div>

        <!-- Rapportini -->
        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--reports" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="4.5" y="3.5" width="15" height="17" rx="2" ry="2" />
                            <path d="M8 8.5h8M8 12h8M8 15.5h5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}Rapports{% else %}Rapportini{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <p>
                    {% if lang == 'fr' %}
                        Consultez, filtrez et analysez tous les rapports envoy√©s par les chefs d'√©quipe.
                    {% else %}
                        Consulta, filtra e approfondisci tutti i rapportini inviati dai capisquadra.
                    {% endif %}
                </p>
                <div class="card-actions">
                    <a href="/manager/rapportini" class="btn btn-secondary">
                        {% if lang == 'fr' %}Aller √† la liste des rapports{% else %}Vai all'elenco rapportini{% endif %}
                    </a>
                </div>
            </div>
        </div>

        <!-- Utenti -->
        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--users" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="9" cy="9" r="3" />
                            <circle cx="16" cy="10" r="2.5" />
                            <path d="M4.5 19.5c0-2.5 2.3-4.5 5.1-4.5h1.8c2.8 0 5.1 2 5.1 4.5" stroke-linecap="round" />
                            <path d="M15.4 12.8c2.2 0 4.1 1.6 4.1 3.7" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}Utilisateurs{% else %}Utenti{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <p>
                    {% if lang == 'fr' %}
                        G√©rez les utilisateurs, cr√©ez de nouveaux chefs d'√©quipe et modifiez les r√¥les selon les besoins op√©rationnels.
                    {% else %}
                        Gestisci gli utenti, crea nuovi capisquadra e modifica i ruoli in base alle necessit√† operative.
                    {% endif %}
                </p>
                <div class="card-actions">
                    <a href="/manager/utenti" class="btn btn-secondary">
                        {% if lang == 'fr' %}Liste des utilisateurs{% else %}Lista utenti{% endif %}
                    </a>
                    <a href="/manager/utenti/nuovo" class="btn btn-primary">
                        ‚ûï {% if lang == 'fr' %}Nouvel utilisateur{% else %}Nuovo utente{% endif %}
                    </a>
                </div>
            </div>
        </div>

        <!-- Personale -->
        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--users" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="9" cy="9" r="3" />
                            <circle cx="16" cy="10" r="2.5" />
                            <path d="M4.5 19.5c0-2.5 2.3-4.5 5.1-4.5h1.8c2.8 0 5.1 2 5.1 4.5" stroke-linecap="round" />
                            <path d="M15.4 12.8c2.2 0 4.1 1.6 4.1 3.7" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}Personnel{% else %}Personale{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <p>
                    {% if lang == 'fr' %}
                        G√©rez l‚Äôensemble du personnel (√©quipes, op√©rateurs, chefs d‚Äô√©quipe, etc.).
                    {% else %}
                        Gestisci tutto il personale (operatori, capisquadra, ecc.).
                    {% endif %}
                </p>
                <div class="card-actions">
                    <a href="{{ url_for('manager_personale_list') }}" class="btn btn-secondary">
                        üìã {% if lang == 'fr' %}Liste du personnel{% else %}Lista personale{% endif %}
                    </a>
                    <a href="{{ url_for('manager_personale_new') }}" class="btn btn-primary">
                        ‚ûï {% if lang == 'fr' %}Nouvel employ√©{% else %}Nuovo personale{% endif %}
                    </a>
                </div>
            </div>
        </div>

        <!-- Attivit√† recente -->
        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--activity" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="5" y="4" width="6" height="6" rx="1.2" />
                            <rect x="13" y="4" width="6" height="6" rx="1.2" />
                            <rect x="5" y="12" width="6" height="8" rx="1.2" />
                            <rect x="13" y="12" width="6" height="8" rx="1.2" />
                        </svg>
                    </div>
                    <span>{% if lang == 'fr' %}Activit√© r√©cente{% else %}Attivit√† recente{% endif %}</span>
                </div>
            </div>
            <div class="card-body">
                <p>
                    {% if lang == 'fr' %}
                        Tendance hebdomadaire des envois de rapports.
                    {% else %}
                        Andamento settimanale degli invii dei rapportini.
                    {% endif %}
                </p>
                <div class="mini-chart" role="img" aria-label="{% if lang == 'fr' %}Tendance des rapports{% else %}Trend rapportini{% endif %}">
                    <svg width="100%" height="50" viewBox="0 0 {{ 20 * (trend_counts|length) }} 50" preserveAspectRatio="none">
                        {% for value in trend_counts %}
                            {% set bar_height = (value / (max_trend or 1)) * 40 %}
                            <rect x="{{ loop.index0 * 20 + 2 }}" y="{{ 46 - bar_height }}" width="14" height="{{ bar_height }}" rx="3" class="trend-bar" />
                        {% endfor %}
                        {% if not trend_counts %}
                            <text x="4" y="30" fill="currentColor" opacity="0.6">
                                {% if lang == 'fr' %}Aucune donn√©e{% else %}Nessun dato{% endif %}
                            </text>
                        {% endif %}
                    </svg>
                </div>
                <div class="card-actions">
                    <a href="/manager/rapportini" class="btn btn-secondary btn-sm">
                        {% if lang == 'fr' %}D√©tails des rapports{% else %}Dettagli rapportini{% endif %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-analytics-grid">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--reports" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="4.5" y="3.5" width="15" height="17" rx="2" ry="2" />
                            <path d="M8 8.5h8M8 12h8M8 15.5h5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>
                        {% if lang == 'fr' %}
                            Rapports des 30 derniers jours
                        {% else %}
                            Rapportini ultimi 30 giorni
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <canvas id="chartReportsLast30Days"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--sites" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 11.5L12 5l8 6.5V20H4z" stroke-linejoin="round" />
                            <path d="M10 20v-5h4v5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>
                        {% if lang == 'fr' %}
                            Heures par chantier (30 jours)
                        {% else %}
                            Ore per cantiere (30 giorni)
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <canvas id="chartHoursPerSite"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--reports" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="4.5" y="3.5" width="15" height="17" rx="2" ry="2" />
                            <path d="M8 8.5h8M8 12h8M8 15.5h5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>
                        {% if lang == 'fr' %}
                            Statut des rapports
                        {% else %}
                            Stato rapportini
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <canvas id="chartReportsByStatus"></canvas>
            </div>
        </div>
    </div>

    <div class="card dashboard-map-card">
        <div class="card-header">
            <div class="card-title">
                <div class="card-icon card-icon--sites" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 11.5L12 5l8 6.5V20H4z" stroke-linejoin="round" />
                        <path d="M10 20v-5h4v5" stroke-linecap="round" />
                    </svg>
                </div>
                <span>{% if lang == 'fr' %}Carte des chantiers{% else %}Mappa cantieri{% endif %}</span>
            </div>
        </div>
        <div class="card-body">
            {% if google_maps_api_key %}
                <div class="map-filters" aria-label="{% if lang == 'fr' %}Filtres carte{% else %}Filtri mappa{% endif %}">
                    <label class="map-filter">
                        <span class="map-filter-label">{% if lang == 'fr' %}Statut{% else %}Stato cantiere{% endif %}</span>
                        <select id="map-filter-status" class="form-select">
                            <option value="">{% if lang == 'fr' %}Tous{% else %}Tutti{% endif %}</option>
                        </select>
                    </label>
                    <label class="map-filter">
                        <span class="map-filter-label">{% if lang == 'fr' %}Chef d'√©quipe{% else %}Caposquadra{% endif %}</span>
                        <select id="map-filter-caposquadra" class="form-select">
                            <option value="">{% if lang == 'fr' %}Tous{% else %}Tutti{% endif %}</option>
                        </select>
                    </label>
                    <label class="map-filter">
                        <span class="map-filter-label">{% if lang == 'fr' %}Actifs{% else %}Attivi{% endif %}</span>
                        <select id="map-filter-active" class="form-select">
                            <option value="">{% if lang == 'fr' %}Tous{% else %}Tutti{% endif %}</option>
                            <option value="true">{% if lang == 'fr' %}Actifs{% else %}Attivi{% endif %}</option>
                            <option value="false">{% if lang == 'fr' %}Inactifs{% else %}Non attivi{% endif %}</option>
                        </select>
                    </label>
                </div>
                <div id="manager-map" class="cantieri-map" aria-label="{% if lang == 'fr' %}Carte des chantiers{% else %}Mappa cantieri{% endif %}"></div>
            {% else %}
                <div class="map-disabled-message">
                    {% if lang == 'fr' %}
                        Carte d√©sactiv√©e (GOOGLE_MAPS_API_KEY manquant)
                    {% else %}
                        Mappa disattivata (manca GOOGLE_MAPS_API_KEY)
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    window.managerDashboardData = {
        reportsLast30Days: {{ chart_reports_last_30_days | tojson | safe }},
        hoursPerSite30Days: {{ chart_hours_per_site_30_days | tojson | safe }},
        reportsByStatus: {{ chart_reports_by_status | tojson | safe }}
    };
</script>
{% if google_maps_api_key %}
    <script>
        const cantieriMapData = {{ cantieri_map_data | tojson | safe }};

        function initMap() {
            const mapElement = document.getElementById("manager-map");
            if (!mapElement) {
                return;
            }

            const map = new google.maps.Map(mapElement, {
                mapTypeControl: false,
                fullscreenControl: false
            });
            const infoWindow = new google.maps.InfoWindow();
            const detailUrlTemplate = "{{ url_for('manager_cantiere_modifica_get', site_id='__SITE_ID__') }}";
            const markers = [];

            const statusSelect = document.getElementById("map-filter-status");
            const caposquadraSelect = document.getElementById("map-filter-caposquadra");
            const activeSelect = document.getElementById("map-filter-active");

            const uniqueStatuses = new Map();
            const uniqueCaposquadra = new Map();

            cantieriMapData.forEach((site) => {
                if (site.status && !uniqueStatuses.has(site.status)) {
                    uniqueStatuses.set(site.status, site.status);
                }
                if (site.caposquadra_id && !uniqueCaposquadra.has(site.caposquadra_id)) {
                    uniqueCaposquadra.set(site.caposquadra_id, site.caposquadra_name || `#${site.caposquadra_id}`);
                }
            });

            const appendOptions = (select, options) => {
                if (!select) {
                    return;
                }
                options.forEach(([value, label]) => {
                    const option = document.createElement("option");
                    option.value = value;
                    option.textContent = label;
                    select.append(option);
                });
            };

            appendOptions(
                statusSelect,
                Array.from(uniqueStatuses.entries()).sort((a, b) => a[1].localeCompare(b[1]))
            );
            appendOptions(
                caposquadraSelect,
                Array.from(uniqueCaposquadra.entries()).sort((a, b) => a[1].localeCompare(b[1]))
            );

            cantieriMapData.forEach((site) => {
                const position = { lat: site.lat, lng: site.lng };
                const marker = new google.maps.Marker({
                    position,
                    map,
                    title: site.name
                });
                markers.push({ marker, site });

                const detailUrl = detailUrlTemplate.replace("__SITE_ID__", site.id);
                const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${site.lat},${site.lng}`;
                const indirizzo = site.address
                    ? `<div class="map-infowindow-address">${site.address}</div>`
                    : "";
                const content = `
                    <div class="map-infowindow">
                        <div class="map-infowindow-title">${site.name}</div>
                        ${indirizzo}
                        <div class="map-infowindow-actions">
                            <a href="${detailUrl}" class="btn btn-sm btn-secondary">Apri scheda</a>
                            <a href="${directionsUrl}" class="btn btn-sm btn-primary" target="_blank" rel="noopener">Portami l√¨</a>
                        </div>
                    </div>
                `;

                marker.addListener("click", () => {
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                });
            });

            const updateMapBounds = () => {
                const bounds = new google.maps.LatLngBounds();
                let visibleCount = 0;

                markers.forEach(({ marker }) => {
                    if (marker.getVisible()) {
                        bounds.extend(marker.getPosition());
                        visibleCount += 1;
                    }
                });

                if (visibleCount > 0) {
                    map.fitBounds(bounds);
                    if (visibleCount === 1) {
                        map.setZoom(12);
                    }
                } else {
                    map.setCenter({ lat: 46.2276, lng: 2.2137 });
                    map.setZoom(6);
                }
            };

            const applyFilters = () => {
                const selectedStatus = statusSelect?.value || "";
                const selectedCapo = caposquadraSelect?.value || "";
                const selectedActive = activeSelect?.value || "";

                markers.forEach(({ marker, site }) => {
                    const matchesStatus = !selectedStatus || site.status === selectedStatus;
                    const matchesCapo =
                        !selectedCapo || String(site.caposquadra_id || "") === selectedCapo;
                    const matchesActive =
                        selectedActive === "" || String(Boolean(site.is_active)) === selectedActive;
                    const isVisible = matchesStatus && matchesCapo && matchesActive;
                    marker.setVisible(isVisible);
                });

                updateMapBounds();
            };

            [statusSelect, caposquadraSelect, activeSelect].forEach((select) => {
                select?.addEventListener("change", applyFilters);
            });

            applyFilters();
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"></script>
{% endif %}
<script src="{{ url_for('static', path='/js/manager_dashboard_charts.js') }}"></script>
{% endblock %}
