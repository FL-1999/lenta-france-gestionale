{% extends "base.html" %}

{% block title %}Dashboard Manager – Lenta France{% endblock %}

{% block content %}
<div class="dashboard-page">
    <div class="page-header dashboard-header">
        <div>
            <p class="eyebrow">Pannello Manager</p>
            <h1>Dashboard Manager</h1>
            <p>Benvenuto{{ ' ' + user.full_name if user and user.full_name else '' }}, qui trovi il riepilogo dei rapportini salvati e le scorciatoie per la gestione.</p>
        </div>
        <div class="header-actions">
            <a href="/capo/rapportini/nuovo" class="btn btn-lg btn-primary">➕ Nuovo rapportino</a>
            <a href="/manager/rapportini" class="btn btn-lg btn-secondary">Elenco rapportini</a>
            <a href="/manager/fiches" class="btn btn-lg btn-secondary">Vedi fiches</a>
        </div>
    </div>

    {% set rapportini_totali = reports_count|default(rapportini_count|default('—')) %}
    {% set cantieri_totali = sites_count|default(cantieri_count|default('—')) %}
    {% set macchinari_totali = macchinari_count|default(machines_count|default('—')) %}
    {% set utenti_totali = users_count|default('—') %}

    <div class="dashboard-kpi-grid">
        <div class="kpi-card kpi-accent-1">
            <div class="kpi-top">
                <div class="card-icon card-icon--reports" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="4.5" y="3.5" width="15" height="17" rx="2" ry="2" />
                        <path d="M8 8.5h8M8 12h8M8 15.5h5" stroke-linecap="round" />
                    </svg>
                </div>
                <span class="kpi-label">Rapportini totali</span>
            </div>
            <div class="kpi-value">{{ rapportini_totali }}</div>
            <div class="kpi-sub">Aggiornato giornalmente</div>
        </div>

        <div class="kpi-card kpi-accent-2">
            <div class="kpi-top">
                <div class="card-icon card-icon--sites" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 11.5L12 5l8 6.5V20H4z" stroke-linejoin="round" />
                        <path d="M10 20v-5h4v5" stroke-linecap="round" />
                    </svg>
                </div>
                <span class="kpi-label">Cantieri attivi</span>
            </div>
            <div class="kpi-value">{{ cantieri_totali }}</div>
            <div class="kpi-sub">In lavorazione</div>
        </div>

        <div class="kpi-card kpi-accent-3">
            <div class="kpi-top">
                <div class="card-icon card-icon--machines" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="7" />
                        <path d="M12 8.5v-2M12 17.5v-2M15.5 12h2M6.5 12h2M14.95 9.05l1.35-1.35M7.7 16.3l1.35-1.35M9.05 9.05 7.7 7.7M16.3 16.3l-1.35-1.35" stroke-linecap="round" />
                        <circle cx="12" cy="12" r="2.3" />
                    </svg>
                </div>
                <span class="kpi-label">Macchinari disponibili</span>
            </div>
            <div class="kpi-value">{{ macchinari_totali }}</div>
            <div class="kpi-sub">Parco mezzi</div>
        </div>

        <div class="kpi-card kpi-accent-4">
            <div class="kpi-top">
                <div class="card-icon card-icon--users" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="9" cy="9" r="3" />
                        <circle cx="16" cy="10" r="2.5" />
                        <path d="M4.5 19.5c0-2.5 2.3-4.5 5.1-4.5h1.8c2.8 0 5.1 2 5.1 4.5" stroke-linecap="round" />
                        <path d="M15.4 12.8c2.2 0 4.1 1.6 4.1 3.7" stroke-linecap="round" />
                    </svg>
                </div>
                <span class="kpi-label">Utenti registrati</span>
            </div>
            <div class="kpi-value">{{ utenti_totali }}</div>
            <div class="kpi-sub">Manager e capisquadra</div>
        </div>
    </div>

    {% set trend_counts = rapportini_trend|default(reports_trend|default([5, 7, 4, 6, 5, 8, 6])) %}
    {% set max_trend = trend_counts|max if trend_counts else 1 %}

    <div class="dashboard-modules-grid">
        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--sites" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 11.5L12 5l8 6.5V20H4z" stroke-linejoin="round" />
                            <path d="M10 20v-5h4v5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>Cantieri</span>
                </div>
            </div>
            <div class="card-body">
                <p>Monitora l'avanzamento dei cantieri, gestisci dettagli e assegnazioni delle squadre.</p>
            <div class="card-actions">
                <a href="/manager/cantieri" class="btn btn-secondary">Lista cantieri</a>
                <a href="/manager/cantieri/nuovo" class="btn btn-primary">➕ Nuovo cantiere</a>
            </div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--machines" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="7" />
                            <path d="M12 8.5v-2M12 17.5v-2M15.5 12h2M6.5 12h2M14.95 9.05l1.35-1.35M7.7 16.3l1.35-1.35M9.05 9.05 7.7 7.7M16.3 16.3l-1.35-1.35" stroke-linecap="round" />
                            <circle cx="12" cy="12" r="2.3" />
                        </svg>
                    </div>
                    <span>Macchinari</span>
                </div>
            </div>
            <div class="card-body">
                <p>Gestisci il parco macchinari, lo stato e le assegnazioni ai cantieri in corso.</p>
            <div class="card-actions">
                <a href="/manager/macchinari" class="btn btn-secondary">Lista macchinari</a>
            </div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--fiches" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.5 4h7L17.5 7.5V20h-10V4z" stroke-linejoin="round" />
                            <path d="M14.5 4v4h4" stroke-linejoin="round" />
                            <path d="M9.5 11h5" stroke-linecap="round" />
                            <path d="M9.5 14h5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>Fiches</span>
                </div>
            </div>
            <div class="card-body">
                <p>Consulta e filtra le fiches inserite dai capisquadra per avere una vista rapida delle attività.</p>
            <div class="card-actions">
                <a href="/manager/fiches" class="btn btn-secondary">Vedi fiches</a>
            </div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--reports" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="4.5" y="3.5" width="15" height="17" rx="2" ry="2" />
                            <path d="M8 8.5h8M8 12h8M8 15.5h5" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>Rapportini</span>
                </div>
            </div>
            <div class="card-body">
                <p>Consulta, filtra e approfondisci tutti i rapportini inviati dai capisquadra.</p>
            <div class="card-actions">
                <a href="/manager/rapportini" class="btn btn-secondary">Vai all'elenco rapportini</a>
            </div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--users" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="9" cy="9" r="3" />
                            <circle cx="16" cy="10" r="2.5" />
                            <path d="M4.5 19.5c0-2.5 2.3-4.5 5.1-4.5h1.8c2.8 0 5.1 2 5.1 4.5" stroke-linecap="round" />
                            <path d="M15.4 12.8c2.2 0 4.1 1.6 4.1 3.7" stroke-linecap="round" />
                        </svg>
                    </div>
                    <span>Utenti</span>
                </div>
            </div>
            <div class="card-body">
                <p>Gestisci gli utenti, crea nuovi capisquadra e modifica i ruoli in base alle necessità operative.</p>
            <div class="card-actions">
                <a href="/manager/utenti" class="btn btn-secondary">Lista utenti</a>
                <a href="/manager/utenti/nuovo" class="btn btn-primary">➕ Nuovo utente</a>
            </div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon card-icon--activity" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="5" y="4" width="6" height="6" rx="1.2" />
                            <rect x="13" y="4" width="6" height="6" rx="1.2" />
                            <rect x="5" y="12" width="6" height="8" rx="1.2" />
                            <rect x="13" y="12" width="6" height="8" rx="1.2" />
                        </svg>
                    </div>
                    <span>Attività recente</span>
                </div>
            </div>
            <div class="card-body">
                <p>Andamento settimanale degli invii dei rapportini.</p>
                <div class="mini-chart" role="img" aria-label="Trend rapportini">
                    <svg width="100%" height="50" viewBox="0 0 {{ 20 * (trend_counts|length) }} 50" preserveAspectRatio="none">
                        {% for value in trend_counts %}
                            {% set bar_height = (value / (max_trend or 1)) * 40 %}
                            <rect x="{{ loop.index0 * 20 + 2 }}" y="{{ 46 - bar_height }}" width="14" height="{{ bar_height }}" rx="3" class="trend-bar" />
                        {% endfor %}
                        {% if not trend_counts %}
                            <text x="4" y="30" fill="currentColor" opacity="0.6">Nessun dato</text>
                        {% endif %}
                    </svg>
                </div>
                <div class="card-actions">
                    <a href="/manager/rapportini" class="btn btn-secondary btn-sm">Dettagli rapportini</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
