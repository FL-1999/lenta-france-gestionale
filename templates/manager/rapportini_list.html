{% extends "shared/base.html" %}
{% set lang = request.cookies.get('lang', 'it') %}

{% block title %}
    {% if lang == 'fr' %}Rapports ‚Äì Manager ‚Äì Lenta France{% else %}Rapportini ‚Äì Manager ‚Äì Lenta France{% endif %}
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-main">
        <p class="page-eyebrow">
            {% if lang == 'fr' %}Gestion des rapports{% else %}Gestione rapportini{% endif %}
        </p>
        <h1 class="page-title">
            <span class="page-icon page-icon--reports" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4.5" y="3.5" width="15" height="17" rx="2" ry="2" />
                    <path d="M8 8.5h8M8 12h8M8 15.5h5" stroke-linecap="round" />
                </svg>
            </span>
            {% if lang == 'fr' %}Rapports{% else %}Rapportini{% endif %}
        </h1>
        <p class="page-subtitle">
            {% if lang == 'fr' %}
                Filtrez et consultez les rapports quotidiens envoy√©s par les chefs d'√©quipe.
            {% else %}
                Filtra e consulta i rapportini giornalieri inviati dai capisquadra.
            {% endif %}
        </p>
    </div>
    <div class="page-actions">
        <a href="/capo/rapportini/nuovo" class="btn btn-primary">
            ‚ûï {% if lang == 'fr' %}Nouveau rapport{% else %}Nuovo rapportino{% endif %}
        </a>
    </div>
</div>

<div class="page-actions-sticky">
    <a href="/manager/rapportini" class="btn btn-secondary is-active">
        {% if lang == 'fr' %}Liste{% else %}Elenco{% endif %}
    </a>
    <a href="/capo/rapportini/nuovo" class="btn btn-primary">
        ‚ûï {% if lang == 'fr' %}Nouveau{% else %}Nuovo{% endif %}
    </a>
</div>

<div class="card" style="margin-bottom: var(--space-3);">
    <div class="card-header">
        <div class="card-title">
            üîç {% if lang == 'fr' %}Filtrer les r√©sultats{% else %}Filtra i risultati{% endif %}
        </div>
    </div>
    <div class="card-body">
        <form method="get" class="form-grid">
            <div class="form-group">
                <label for="start_date" class="form-label">
                    {% if lang == 'fr' %}Date de d√©but{% else %}Data inizio{% endif %}
                </label>
                <input type="date" id="start_date" name="start_date" class="form-control" value="{{ filters.start_date or '' }}">
            </div>
            <div class="form-group">
                <label for="end_date" class="form-label">
                    {% if lang == 'fr' %}Date de fin{% else %}Data fine{% endif %}
                </label>
                <input type="date" id="end_date" name="end_date" class="form-control" value="{{ filters.end_date or '' }}">
            </div>
            <div class="form-group">
                <label for="site_id" class="form-label">
                    {% if lang == 'fr' %}Chantier{% else %}Cantiere{% endif %}
                </label>
                <select id="site_id" name="site_id" class="form-select">
                    <option value="">{% if lang == 'fr' %}Tous{% else %}Tutti{% endif %}</option>
                    {% for s in sites %}
                        <option value="{{ s.id }}" {% if filters.site_id and filters.site_id == s.id %}selected{% endif %}>
                            {{ s.name }}{% if s.code %} ({{ s.code }}){% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="created_by" class="form-label">
                    {% if lang == 'fr' %}Chef d'√©quipe{% else %}Caposquadra{% endif %}
                </label>
                <select id="created_by" name="created_by" class="form-select">
                    <option value="">{% if lang == 'fr' %}Tous{% else %}Tutti{% endif %}</option>
                    {% for c in capisquadra %}
                        <option value="{{ c.id }}" {% if filters.created_by and filters.created_by == c.id %}selected{% endif %}>
                            {{ c.full_name or c.email }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-actions" style="justify-content: flex-end; margin-top: 0;">
                <button type="submit" class="btn btn-secondary">
                    {% if lang == 'fr' %}Filtrer{% else %}Filtra{% endif %}
                </button>
                <a href="/manager/rapportini" class="btn btn-secondary">
                    {% if lang == 'fr' %}R√©initialiser{% else %}Reset{% endif %}
                </a>
            </div>
        </form>
    </div>
</div>

<div class="card table-card">
    <div class="card-header">
        <div class="card-title">
            üìù {% if lang == 'fr' %}Liste des rapports{% else %}Elenco rapportini{% endif %}
        </div>
    </div>
    <div class="card-body">
        <table class="data-table">
            <thead>
                <tr>
                    <th>{% if lang == 'fr' %}Date{% else %}Data{% endif %}</th>
                    <th>{% if lang == 'fr' %}Chantier{% else %}Cantiere{% endif %}</th>
                    <th>{% if lang == 'fr' %}Heures totales{% else %}Ore totali{% endif %}</th>
                    <th>{% if lang == 'fr' %}Ouvriers{% else %}Operai{% endif %}</th>
                    <th>{% if lang == 'fr' %}Chef d'√©quipe{% else %}Caposquadra{% endif %}</th>
                    <th>{% if lang == 'fr' %}Notes / Activit√©s{% else %}Note / attivit√†{% endif %}</th>
                    <th class="table-actions-col">{% if lang == 'fr' %}Actions{% else %}Azioni{% endif %}</th>
                </tr>
            </thead>
            <tbody>
                {% set reports_list = reports | default([]) %}
                {% for r in reports_list %}
                <tr>
                    <td>{{ r.date.strftime("%d/%m/%Y") if r.date else "-" }}</td>
                    <td>
                        {% if r.site %}
                            {{ r.site.name }}{% if r.site.code %} ({{ r.site.code }}){% endif %}
                        {% else %}
                            {{ r.site_name_or_code }}
                        {% endif %}
                    </td>
                    <td>{{ "%.1f"|format(r.total_hours) }}</td>
                    <td>{{ r.workers_count }}</td>
                    <td>
                        {% if r.created_by %}
                            {{ r.created_by.full_name or r.created_by.email }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% set preview = r.notes or r.activities or "-" %}
                        {% if preview|length > 40 %}
                            {{ preview[:40] }}‚Ä¶
                        {% else %}
                            {{ preview }}
                        {% endif %}
                    </td>
                    <td class="table-actions">
                        <a href="/manager/rapportini/{{ r.id }}" class="btn btn-sm btn-secondary">
                            {% if lang == 'fr' %}Voir{% else %}Vedi{% endif %}
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="table-empty">
                        {% if lang == 'fr' %}
                            Aucun rapport trouv√© avec les filtres s√©lectionn√©s.
                        {% else %}
                            Nessun rapportino trovato con i filtri selezionati.
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if reports_list and reports_list|length > 0 %}
        <div class="card-actions" style="justify-content: space-between; align-items: center; margin-top: var(--space-3);">
            <div class="text-muted">
                {% if lang == 'fr' %}
                    Page {{ page }} sur {{ total_pages }}
                {% else %}
                    Pagina {{ page }} di {{ total_pages }}
                {% endif %}
            </div>
            <div class="table-actions">
                {% if page > 1 %}
                    <a class="btn btn-secondary btn-sm" href="{{ request.url.include_query_params(page=page-1) }}">&laquo; {% if lang == 'fr' %}Pr√©c√©dent{% else %}Precedente{% endif %}</a>
                {% endif %}
                {% if page < total_pages %}
                    <a class="btn btn-secondary btn-sm" href="{{ request.url.include_query_params(page=page+1) }}">{% if lang == 'fr' %}Suivant{% else %}Successiva{% endif %} &raquo;</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
