{% extends "base.html" %}

{% block title %}
{% if mode == "create" %}Nuovo cantiere{% else %}Modifica cantiere{% endif %}
{% endblock %}

{% block content %}
<div class="form-page">
  <div class="form-page-header">
    <p class="eyebrow">Area Manager</p>
    <h1 class="page-title">
      <span class="page-icon page-icon--sites" aria-hidden="true"></span>
      {% if mode == "create" %}Nuovo cantiere{% else %}Modifica cantiere{% endif %}
    </h1>
    <p class="subtitle">
      Compila i dettagli del cantiere per gestire attivitÃ  e pianificazione.
    </p>
  </div>

  <div class="card form-card">
    <div class="card-header">
      <div class="card-title">
        <span>Dettagli cantiere</span>
      </div>
    </div>
    <div class="card-body">
      <form method="post" data-mode="{{ mode }}">
        {% set has_coordinates = site and site.lat is not none and site.lng is not none %}
        {% set has_address = site and (site.address or site.indirizzo) %}
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="name">Nome*</label>
            <input type="text" id="name" name="name" class="form-control" value="{{ site.name if site else '' }}" required>
          </div>

          <div class="form-group">
            <label class="form-label" for="code">Codice*</label>
            <input type="text" id="code" name="code" class="form-control" value="{{ site.code if site else '' }}" required>
          </div>

          <div class="form-group">
            <label class="form-label" for="cantiere_address">Indirizzo</label>
            <input id="cantiere_address"
                   name="address"
                   type="text"
                   class="form-control"
                   placeholder="Inizia a scrivere lâ€™indirizzoâ€¦"
                   autocomplete="off"
                   value="{{ site.address if site else '' }}">
            <small class="form-text text-muted">Scegli dai suggerimenti per avere indirizzo verificato.</small>
          </div>
          {% if not google_maps_api_key %}
            <div class="form-group" style="grid-column: 1 / -1;">
              <div class="alert alert-warning" role="alert">
                Mappa/Autocomplete non disponibili (manca configurazione).
              </div>
            </div>
          {% endif %}
          <div class="form-group" style="grid-column: 1 / -1;">
            <label class="form-label">Posizione su mappa</label>
            <div id="cantiere-pick-map" style="height: 320px;" aria-label="Mappa posizione cantiere"></div>
            {% if google_maps_api_key %}
              <small class="form-text text-muted">Clicca sulla mappa o trascina il pin.</small>
            {% endif %}
          </div>
          <div id="cantiere-unverified-confirm-wrapper"
               class="form-group form-group-inline"
               style="grid-column: 1 / -1; {% if mode == 'edit' and has_address and not has_coordinates %}display:flex;{% else %}display:none;{% endif %}">
            <input type="checkbox"
                   id="cantiere-unverified-confirm"
                   name="confirm_unverified"
                   class="form-control"
                   value="1">
            <label class="form-label" for="cantiere-unverified-confirm">
              Confermo di salvare senza coordinate.
            </label>
          </div>
          <input id="cantiere_place_id" name="place_id" type="hidden" value="{{ site.place_id if site else '' }}">
          <input id="cantiere_lat" name="lat" type="hidden" value="{{ site.lat if site and site.lat is not none else '' }}">
          <input id="cantiere_lng" name="lng" type="hidden" value="{{ site.lng if site and site.lng is not none else '' }}">

          <div class="form-group">
            <label class="form-label" for="city">CittÃ </label>
            <input type="text" id="city" name="city" class="form-control" value="{{ site.city if site else '' }}">
          </div>

          <div class="form-group">
            <label class="form-label" for="country">Nazione</label>
            <input type="text" id="country" name="country" class="form-control" value="{{ site.country if site else '' }}">
          </div>

          <div class="form-group">
            <label class="form-label" for="start_date">Data inizio</label>
            <input type="date" id="start_date" name="start_date" class="form-control"
                   value="{{ site.start_date.isoformat() if site and site.start_date else '' }}">
          </div>

          <div class="form-group">
            <label class="form-label" for="end_date">Data fine</label>
            <input type="date" id="end_date" name="end_date" class="form-control"
                   value="{{ site.end_date.isoformat() if site and site.end_date else '' }}">
          </div>

          <div class="form-group">
            <label class="form-label" for="status">Stato</label>
            <select id="status" name="status" class="form-select" required>
              {% for status in site_status_values %}
                <option value="{{ status }}" {% if site and (site.status.name == status or site.status.value == status) %}selected{% endif %}>
                  {{ status }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="caposquadra_id">Caposquadra responsabile</label>
            <select id="caposquadra_id" name="caposquadra_id" class="form-select">
              {% set selected_capo = site.caposquadra_id if site else '' %}
              <option value="" {% if not selected_capo %}selected{% endif %}>-</option>
              {% for capo in capisquadra %}
                <option value="{{ capo.id }}" {% if selected_capo == capo.id %}selected{% endif %}>
                  {{ capo.full_name or capo.email }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group form-group-inline">
            <input type="checkbox" id="is_active" name="is_active" class="form-control" {% if not site or site.is_active %}checked{% endif %}>
            <label class="form-label" for="is_active">Cantiere attivo</label>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Salva</button>
          {% if site and site.lat and site.lng %}
            <a class="btn btn-primary" target="_blank" rel="noopener"
               href="https://www.google.com/maps/dir/?api=1&destination={{ site.lat }},{{ site.lng }}">
              ðŸ§­ Portami lÃ¬
            </a>
          {% elif site and (site.address or site.indirizzo) %}
            <a class="btn btn-primary" target="_blank" rel="noopener"
               href="https://www.google.com/maps/dir/?api=1&destination={{ (site.address or site.indirizzo) | urlencode }}">
              ðŸ§­ Portami lÃ¬
            </a>
          {% endif %}
          <a href="/manager/cantieri" class="btn btn-secondary">Annulla</a>
        </div>
      </form>
    </div>
  </div>
</div>

{% if mode == "edit" %}
  <div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
      <div class="card-title">
        <span>Materiale scaricato</span>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Articolo</th>
              <th>QuantitÃ </th>
              <th>Utente</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody>
            {% if scarichi_recenti %}
              {% for movimento in scarichi_recenti %}
                <tr>
                  <td>{{ movimento.created_at.strftime('%d/%m/%Y %H:%M') if movimento.created_at else 'â€”' }}</td>
                  <td>
                    {% if movimento.item %}
                      {{ movimento.item.codice or 'â€”' }} - {{ movimento.item.nome }}
                    {% else %}
                      â€”
                    {% endif %}
                  </td>
                  <td>{{ movimento.quantita }}</td>
                  <td>{{ movimento.creato_da_user.full_name if movimento.creato_da_user and movimento.creato_da_user.full_name else (movimento.creato_da_user.email if movimento.creato_da_user else 'â€”') }}</td>
                  <td>{{ movimento.note or 'â€”' }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="muted">Nessun movimento registrato.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endif %}

<script src="{{ url_for('static', path='/js/cantiere-form-map.js') }}"></script>
{% if google_maps_api_key %}
  <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initCantiereFormMap"
          async defer></script>
{% endif %}
{% endblock %}
