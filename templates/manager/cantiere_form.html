{% extends "base.html" %}

{% block title %}
{{ "Nuovo cantiere" if mode == "create" else "Modifica cantiere" }}
{% endblock %}

{% block content %}
<div class="form-page">
  <div class="form-page-header">
    <p class="eyebrow">Area Manager</p>
    <h1 class="page-title">
      <span class="page-icon page-icon--sites" aria-hidden="true"></span>
      {{ "Nuovo cantiere" if mode == "create" else "Modifica cantiere" }}
    </h1>
    <p class="subtitle">
      Compila i dettagli del cantiere per gestire attivit√† e pianificazione.
    </p>
  </div>

  <div class="card form-card">
    <div class="card-header">
      <div class="card-title">
        <span>Dettagli cantiere</span>
      </div>
    </div>
    <div class="card-body">
      {% set is_capo = user and user.role and user.role.value == 'caposquadra' %}
      {% set form_data = form_data or {} %}
      {% set form_submitted = form_submitted or false %}
      {% set form_name = form_data.get('name') %}
      {% set form_code = form_data.get('code') %}
      {% set form_city = form_data.get('city') %}
      {% set form_country = form_data.get('country') %}
      {% set form_start_date = form_data.get('start_date') %}
      {% set form_end_date = form_data.get('end_date') %}
      {% set form_address = form_data.get('address') %}
      {% set form_lat = form_data.get('lat') %}
      {% set form_lng = form_data.get('lng') %}
      {% set form_place_id = form_data.get('place_id') %}
      {% set form_status = form_data.get('status') %}
      {% set form_capo = form_data.get('caposquadra_id') %}
      {% set form_active = form_data.get('is_active') %}
      {% set form_confirm_unverified = form_data.get('confirm_unverified') %}
      <form method="post" data-mode="{{ mode }}" class="cantiere-form">
        {% set has_coordinates = (form_lat is not none and form_lng is not none) or (site and site.lat is not none and site.lng is not none) %}
        {% set has_address = (form_address is not none and form_address | trim != '') or (site and (site.address or site.indirizzo)) %}
        {% set address_status_class = 'badge-success' if has_coordinates else 'badge-danger' %}
        {% set address_status_label = 'Verificato ‚úÖ' if has_coordinates else 'Non verificato ‚ö†Ô∏è' %}
        {% set address_alert_style = 'display:block;' if has_address and not has_coordinates else 'display:none;' %}
        {% set address_confirm_style = 'display:flex;' if has_address and not has_coordinates else 'display:none;' %}
        {% if error_message %}
          <div class="alert alert-danger" role="alert" style="margin-bottom: 1rem;">
            {{ error_message }}
          </div>
        {% endif %}
        <div class="cantiere-stepper" data-cantiere-stepper>
          <div class="cantiere-stepper-item is-active" data-step-index="0">
            <span class="cantiere-stepper-index">1</span>
            <span class="cantiere-stepper-label">Dati base</span>
          </div>
          <div class="cantiere-stepper-item" data-step-index="1">
            <span class="cantiere-stepper-index">2</span>
            <span class="cantiere-stepper-label">Indirizzo + mappa</span>
          </div>
          <div class="cantiere-stepper-item" data-step-index="2">
            <span class="cantiere-stepper-index">3</span>
            <span class="cantiere-stepper-label">Assegnazione / stato</span>
          </div>
        </div>

        <div class="cantiere-step is-active" data-step="1">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="name">Nome*</label>
              <input type="text" id="name" name="name" class="form-control" value="{{ form_name if form_name is not none else (site.name if site else '') }}" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="code">Codice*</label>
              <input type="text" id="code" name="code" class="form-control" value="{{ form_code if form_code is not none else (site.code if site else '') }}" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="city">Citt√†</label>
              <input type="text" id="city" name="city" class="form-control" value="{{ form_city if form_city is not none else (site.city if site else '') }}">
            </div>

            <div class="form-group">
              <label class="form-label" for="country">Nazione</label>
              <input type="text" id="country" name="country" class="form-control" value="{{ form_country if form_country is not none else (site.country if site else '') }}">
            </div>

            <div class="form-group">
              <label class="form-label" for="start_date">Data inizio</label>
              <input type="date" id="start_date" name="start_date" class="form-control"
                     value="{{ form_start_date if form_start_date is not none else (site.start_date.isoformat() if site and site.start_date else '') }}">
            </div>

            <div class="form-group">
              <label class="form-label" for="end_date">Data fine</label>
              <input type="date" id="end_date" name="end_date" class="form-control"
                     value="{{ form_end_date if form_end_date is not none else (site.end_date.isoformat() if site and site.end_date else '') }}">
            </div>
          </div>
        </div>

        <div class="cantiere-step" data-step="2">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="cantiere-address">Indirizzo</label>
              <input id="cantiere-address"
                     name="address"
                     type="text"
                     class="form-control"
                     {% if is_capo %}readonly{% endif %}
                     placeholder="Inizia a scrivere l‚Äôindirizzo‚Ä¶"
                     autocomplete="off"
                     value="{{ form_address if form_address is not none else (site.address if site else '') }}">
              {% if not is_capo %}
                <small class="form-text text-muted">
                  Scegli dai suggerimenti per avere indirizzo verificato.
                </small>

                <div class="form-text" style="margin-top: 0.35rem;">
                  <span id="cantiere-address-status"
                        class="badge address-status-badge {{ address_status_class }}">
                    {{ address_status_label }}
                  </span>
                </div>

                <div id="cantiere-address-alert"
                     class="alert alert-warning"
                     role="alert"
                     style="margin-top: 0.5rem; {{ address_alert_style }}">
                  Seleziona un indirizzo dai suggerimenti o clicca sulla mappa per impostare la posizione.
                </div>
              {% else %}
                <small class="form-text text-muted">
                  Indirizzo in sola visualizzazione.
                </small>
              {% endif %}

            </div>
            {% if is_capo %}
              <div class="form-group">
                <label class="form-label" for="lat">Latitudine</label>
                <input id="lat"
                       name="lat"
                       type="text"
                       class="form-control"
                       readonly
                       value="{{ form_lat if form_lat is not none else (site.lat if site and site.lat is not none else '') }}">
              </div>

              <div class="form-group">
                <label class="form-label" for="lng">Longitudine</label>
                <input id="lng"
                       name="lng"
                       type="text"
                       class="form-control"
                       readonly
                       value="{{ form_lng if form_lng is not none else (site.lng if site and site.lng is not none else '') }}">
              </div>
            {% endif %}
            {% if not is_capo and not google_maps_api_key %}
              <div class="form-group" style="grid-column: 1 / -1;">
                <div class="alert alert-warning" role="alert">
                  Mappa/Autocomplete non disponibili (manca configurazione).
                </div>
              </div>
            {% endif %}
            {% if not is_capo %}
              <div class="form-group" style="grid-column: 1 / -1;">
                <label class="form-label">Posizione su mappa</label>
                <div id="cantiere-pick-map"
                     style="height: 320px;"
                     aria-label="Mappa posizione cantiere"
                     {% if google_maps_api_key %}data-google-maps-api-key="{{ google_maps_api_key }}"{% endif %}></div>
                {% if google_maps_api_key %}
                  <small class="form-text text-muted">Clicca sulla mappa o trascina il pin.</small>
                {% endif %}
                <div id="cantiere-address-status" class="form-text text-muted" aria-live="polite"></div>
                <div id="cantiere-address-alert" class="alert alert-warning" role="alert" style="display: none;"></div>
              </div>

              <div id="cantiere-unverified-confirm-wrapper"
                   class="form-group form-group-inline"
                   style="grid-column: 1 / -1; {{ address_confirm_style }}">
                <input type="checkbox"
                       id="cantiere-unverified-confirm"
                       name="confirm_unverified"
                       class="form-control"
                       value="1"
                       {% if form_confirm_unverified %}checked{% endif %}>
                <label class="form-label" for="cantiere-unverified-confirm">
                  Confermo salvataggio senza coordinate.
                </label>
              </div>
              <input id="cantiere_place_id" name="place_id" type="hidden" value="{{ form_place_id if form_place_id is not none else (site.place_id if site else '') }}">
              <input id="lat" name="lat" type="hidden" value="{{ form_lat if form_lat is not none else (site.lat if site and site.lat is not none else '') }}">
              <input id="lng" name="lng" type="hidden" value="{{ form_lng if form_lng is not none else (site.lng if site and site.lng is not none else '') }}">
            {% endif %}
          </div>
        </div>

        <div class="cantiere-step" data-step="3">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="status">Stato</label>
              <select id="status" name="status" class="form-select" required>
                {% for status in site_status_values %}
                  <option value="{{ status }}" {% if form_status == status or (form_status is none and site and (site.status.name == status or site.status.value == status)) %}selected{% endif %}>
                    {{ status }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="caposquadra_id">Caposquadra responsabile</label>
              <select id="caposquadra_id" name="caposquadra_id" class="form-select">
                {% set selected_capo = form_capo if form_capo is not none else (site.caposquadra_id if site else '') %}
                <option value="" {% if not selected_capo %}selected{% endif %}>-</option>
                {% for capo in capisquadra %}
                  <option value="{{ capo.id }}" {% if selected_capo == capo.id %}selected{% endif %}>
                    {{ capo.full_name or capo.email }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group form-group-inline">
              <input type="checkbox" id="is_active" name="is_active" class="form-control" {% if (form_submitted and form_active is not none) or (not form_submitted and (not site or site.is_active)) %}checked{% endif %}>
              <label class="form-label" for="is_active">Cantiere attivo</label>
            </div>
          </div>
        </div>

        <div class="cantiere-mobile-actions">
          <a href="/manager/cantieri" class="btn btn-secondary">Annulla</a>
          <div class="cantiere-mobile-actions__nav">
            <button type="button" class="btn btn-secondary" data-step-action="prev">Indietro</button>
            <button type="button" class="btn btn-primary" data-step-action="next">Avanti</button>
          </div>
          <button type="submit" class="btn btn-primary">Salva</button>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Salva</button>
          {% if site and site.lat and site.lng %}
            <a class="btn btn-primary" target="_blank" rel="noopener"
               href="https://www.google.com/maps/dir/?api=1&destination={{ site.lat }},{{ site.lng }}">
              üß≠ Portami l√¨
            </a>
          {% elif site and (site.address or site.indirizzo) %}
            <a class="btn btn-primary" target="_blank" rel="noopener"
               href="https://www.google.com/maps/dir/?api=1&destination={{ (site.address or site.indirizzo) | urlencode }}">
              üß≠ Portami l√¨
            </a>
          {% endif %}
          <a href="/manager/cantieri" class="btn btn-secondary">Annulla</a>
        </div>
      </form>
    </div>
  </div>
</div>

{% if mode == "edit" %}
  {% include "manager/_site_progress_section.html" %}
{% endif %}

{% if mode == "edit" %}
  <div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
      <div class="card-title">
        <span>Materiale scaricato</span>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Articolo</th>
              <th>Quantit√†</th>
              <th>Utente</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody>
            {% if scarichi_recenti %}
              {% for movimento in scarichi_recenti %}
                <tr>
                  <td>{{ movimento.created_at.strftime('%d/%m/%Y %H:%M') if movimento.created_at else '‚Äî' }}</td>
                  <td>
                    {% if movimento.item %}
                      {{ movimento.item.codice or '‚Äî' }} - {{ movimento.item.nome }}
                    {% else %}
                      ‚Äî
                    {% endif %}
                  </td>
                  <td>{{ movimento.quantita }}</td>
                  <td>{{ movimento.creato_da_user.full_name if movimento.creato_da_user and movimento.creato_da_user.full_name else (movimento.creato_da_user.email if movimento.creato_da_user else '‚Äî') }}</td>
                  <td>{{ movimento.note or '‚Äî' }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="muted">Nessun movimento registrato.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endif %}

<script src="{{ url_for('static', path='/js/google-maps-loader.js') }}"></script>
<script src="{{ url_for('static', path='/js/cantiere_form_map.js') }}"></script>
<script src="{{ url_for('static', path='/js/cantiere-form-stepper.js') }}"></script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap" async defer></script>

{% endblock %}
