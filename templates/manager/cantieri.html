{% extends "shared/base.html" %}
{% set lang = request.cookies.get('lang', 'it') %}

{% block title %}
    {% if lang == 'fr' %}Chantiers ‚Äì Manager ‚Äì Lenta France{% else %}Cantieri ‚Äì Manager ‚Äì Lenta France{% endif %}
{% endblock %}

{% block content %}
<div class="page-header">
  <div class="page-header-main">
    <p class="page-eyebrow">
      {% if lang == 'fr' %}Gestion des chantiers{% else %}Gestione cantieri{% endif %}
    </p>
    <h1 class="page-title">
      <span class="page-icon page-icon--sites" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 11.5L12 5l8 6.5V20H4z" stroke-linejoin="round" />
          <path d="M10 20v-5h4v5" stroke-linecap="round" />
        </svg>
      </span>
      {% if lang == 'fr' %}Chantiers{% else %}Cantieri{% endif %}
    </h1>
    <p class="page-subtitle">
      {% if lang == 'fr' %}
        Vue d'ensemble des chantiers g√©r√©s par Lenta France, avec √©tat et activit√©s √† jour.
      {% else %}
        Panoramica dei cantieri gestiti da Lenta France, con stato e attivit√† aggiornati.
      {% endif %}
    </p>
  </div>
  <div class="page-actions">
    <a href="/manager/cantieri/nuovo" class="btn btn-primary">
      ‚ûï {% if lang == 'fr' %}Nouveau chantier{% else %}Nuovo cantiere{% endif %}
    </a>
  </div>
</div>

{% set sites_list = sites | default([]) %}

<div class="list-search-sticky">
  <div class="list-search-inner">
    <label class="form-label" for="list-search">
      {% if lang == 'fr' %}Rechercher un chantier{% else %}Cerca cantiere{% endif %}
    </label>
    <input
      type="search"
      id="list-search"
      class="form-control"
      placeholder="{% if lang == 'fr' %}Nom, code, ville...{% else %}Nome, codice, citt√†...{% endif %}">
  </div>
</div>

<div class="card table-card">
  <div class="card-header">
    <div class="card-title">
      üèóÔ∏è {% if lang == 'fr' %}Liste des chantiers{% else %}Elenco cantieri{% endif %}
    </div>
  </div>
  <div class="card-body list-table">
    <table class="data-table">
      <thead>
        <tr>
          <th>{% if lang == 'fr' %}Nom{% else %}Nome{% endif %}</th>
          <th>{% if lang == 'fr' %}Code{% else %}Codice{% endif %}</th>
          <th>{% if lang == 'fr' %}Ville{% else %}Citt√†{% endif %}</th>
          <th>{% if lang == 'fr' %}Assign√© √†{% else %}Assegnato a{% endif %}</th>
          <th>{% if lang == 'fr' %}Statut{% else %}Stato{% endif %}</th>
          <th class="text-center">{% if lang == 'fr' %}Actif{% else %}Attivo{% endif %}</th>
          <th class="text-center">Mappa</th>
          <th class="table-actions-col">{% if lang == 'fr' %}Actions{% else %}Azioni{% endif %}</th>
        </tr>
      </thead>
      <tbody>
        {% for s in sites_list %}
        {% set caposquadra = site_caposquadra_map.get(s.id) if site_caposquadra_map else None %}
        <tr data-list-item>
          <td><strong>{{ s.name or s.nome or "-" }}</strong></td>
          <td>{{ s.code or "-" }}</td>
          <td>{{ s.city or s.location or "-" }}</td>
          <td>{{ caposquadra.full_name if caposquadra and caposquadra.full_name else "‚Äî" }}</td>
          <td>{{ s.status.value if s.status else "-" }}</td>
          <td class="text-center">
            {% if s.is_active %}
              {% if lang == 'fr' %}Oui{% else %}S√¨{% endif %}
            {% else %}
              {% if lang == 'fr' %}Non{% else %}No{% endif %}
            {% endif %}
          </td>
          <td class="text-center">
            <button type="button"
                    class="btn btn-sm btn-outline-secondary btn-site-map"
                    data-site-name="{{ s.name or s.nome or '' }}"
                    data-lat="{{ s.lat if s.lat is not none else '' }}"
                    data-lng="{{ s.lng if s.lng is not none else '' }}"
                    data-address="{{ s.address or s.indirizzo or '' }}">
              üìç
            </button>
          </td>
          <td class="table-actions">
            <a href="/manager/cantieri/{{ s.id }}/modifica" class="btn btn-secondary btn-sm">
              ‚úèÔ∏è {% if lang == 'fr' %}Modifier{% else %}Modifica{% endif %}
            </a>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="8" class="table-empty">
            {% if lang == 'fr' %}
              Aucun chantier enregistr√© pour le moment.
            {% else %}
              Nessun cantiere presente al momento.
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="list-cards">
  {% for s in sites_list %}
    {% set caposquadra = site_caposquadra_map.get(s.id) if site_caposquadra_map else None %}
    <article class="card list-card" data-list-item>
      <div class="card-body">
        <div class="list-card-header">
          <h3>{{ s.name or s.nome or "-" }}</h3>
          <span class="badge badge-secondary">
            {{ s.status.value if s.status else "-" }}
          </span>
        </div>
        <div class="list-card-meta">
          <div>
            <span class="label">{% if lang == 'fr' %}Code{% else %}Codice{% endif %}</span>
            <span class="value">{{ s.code or "-" }}</span>
          </div>
          <div>
            <span class="label">{% if lang == 'fr' %}Ville{% else %}Citt√†{% endif %}</span>
            <span class="value">{{ s.city or s.location or "-" }}</span>
          </div>
          <div>
            <span class="label">{% if lang == 'fr' %}Assign√© √†{% else %}Assegnato a{% endif %}</span>
            <span class="value">{{ caposquadra.full_name if caposquadra and caposquadra.full_name else "‚Äî" }}</span>
          </div>
          <div>
            <span class="label">{% if lang == 'fr' %}Actif{% else %}Attivo{% endif %}</span>
            <span class="value">
              {% if s.is_active %}
                {% if lang == 'fr' %}Oui{% else %}S√¨{% endif %}
              {% else %}
                {% if lang == 'fr' %}Non{% else %}No{% endif %}
              {% endif %}
            </span>
          </div>
        </div>
        <div class="list-card-actions">
          <button type="button"
                  class="btn btn-sm btn-outline-secondary btn-site-map"
                  data-site-name="{{ s.name or s.nome or '' }}"
                  data-lat="{{ s.lat if s.lat is not none else '' }}"
                  data-lng="{{ s.lng if s.lng is not none else '' }}"
                  data-address="{{ s.address or s.indirizzo or '' }}">
            üìç {% if lang == 'fr' %}Carte{% else %}Mappa{% endif %}
          </button>
          <a href="/manager/cantieri/{{ s.id }}/modifica" class="btn btn-secondary btn-sm">
            ‚úèÔ∏è {% if lang == 'fr' %}Modifier{% else %}Modifica{% endif %}
          </a>
        </div>
      </div>
    </article>
  {% else %}
    <div class="card list-card">
      <div class="card-body table-empty">
        {% if lang == 'fr' %}
          Aucun chantier enregistr√© pour le moment.
        {% else %}
          Nessun cantiere presente al momento.
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>

{% if total_pages and total_pages > 1 %}
  <div class="pagination-row">
    <div class="pagination-meta">
      {% if lang == 'fr' %}Page {{ page }} sur {{ total_pages }}{% else %}Pagina {{ page }} di {{ total_pages }}{% endif %}
    </div>
    <div class="pagination-actions">
      {% if page > 1 %}
        <a class="btn btn-secondary btn-sm" href="{{ request.url.include_query_params(page=page-1, per_page=per_page) }}">&laquo; {% if lang == 'fr' %}Pr√©c√©dent{% else %}Precedente{% endif %}</a>
      {% endif %}
      {% if page < total_pages %}
        <a class="btn btn-secondary btn-sm" href="{{ request.url.include_query_params(page=page+1, per_page=per_page) }}">{% if lang == 'fr' %}Suivant{% else %}Successiva{% endif %} &raquo;</a>
      {% endif %}
    </div>
  </div>
{% endif %}

<div class="modal" id="site-map-preview-modal" aria-hidden="true">
  <div class="modal-backdrop" data-site-map-close></div>
  <div class="modal-content card">
    <div class="card-body">
      <div class="modal-header">
        <h3 class="card-title" id="site-preview-title">üìç Mappa cantiere</h3>
        <button type="button" class="btn btn-secondary btn-sm" data-site-map-close>‚úñ</button>
      </div>
      <p id="site-preview-message" class="text-muted" style="display: none;">Posizione non impostata</p>
      <div id="site-preview-map" style="height: 300px;"></div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', path='/js/list-search.js') }}"></script>
<script src="{{ url_for('static', path='/js/site-map-preview.js') }}"></script>
{% endblock %}
