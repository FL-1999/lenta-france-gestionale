{% extends "shared/base.html" %}
{% set lang = request.cookies.get('lang', 'it') %}

{% block title %}
    {% if lang == 'fr' %}Utilisateurs ‚Äì Manager ‚Äì Lenta France{% else %}Utenti ‚Äì Manager ‚Äì Lenta France{% endif %}
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-main">
        <p class="page-eyebrow">
            {% if lang == 'fr' %}Gestion des comptes{% else %}Gestione account{% endif %}
        </p>
        <h1 class="page-title">
            <span class="page-icon page-icon--users" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="9" cy="9" r="3" />
                    <circle cx="16" cy="10" r="2.5" />
                    <path d="M4.5 19.5c0-2.5 2.3-4.5 5.1-4.5h1.8c2.8 0 5.1 2 5.1 4.5" stroke-linecap="round" />
                    <path d="M15.4 12.8c2.2 0 4.1 1.6 4.1 3.7" stroke-linecap="round" />
                </svg>
            </span>
            {% if lang == 'fr' %}Utilisateurs{% else %}Utenti{% endif %}
        </h1>
        <p class="page-subtitle">
            {% if lang == 'fr' %}
                Vue d'ensemble des comptes habilit√©s au gestionnel, avec r√¥le, langue et statut.
            {% else %}
                Panoramica degli account abilitati al gestionale, con ruolo, lingua e stato.
            {% endif %}
        </p>
    </div>
    <div class="page-actions">
        {% if has_perm(user, 'users.create') %}
        <a href="/manager/utenti/nuovo" class="btn btn-primary">
            ‚ûï {% if lang == 'fr' %}Nouvel utilisateur{% else %}Nuovo utente{% endif %}
        </a>
        {% endif %}
    </div>
</div>

<div class="card table-card">
    <div class="card-header">
        <div class="card-title">
            üë• {% if lang == 'fr' %}Liste des utilisateurs{% else %}Elenco utenti{% endif %}
        </div>
    </div>
    <div class="card-body">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>{% if lang == 'fr' %}Nom complet{% else %}Nome completo{% endif %}</th>
                    <th>{% if lang == 'fr' %}R√¥le{% else %}Ruolo{% endif %}</th>
                    <th>{% if lang == 'fr' %}Chantier assign√©{% else %}Cantiere assegnato{% endif %}</th>
                    <th>{% if lang == 'fr' %}Langue{% else %}Lingua{% endif %}</th>
                    <th>{% if lang == 'fr' %}Actif{% else %}Attivo{% endif %}</th>
                    <th class="table-actions-col">{% if lang == 'fr' %}Actions{% else %}Azioni{% endif %}</th>
                </tr>
            </thead>
            <tbody>
                {% set users_list = users | default([]) %}
                {% for u in users_list %}
                {% set assigned_sites = user_sites_map.get(u.id, []) if user_sites_map else [] %}
                <tr>
                    <td>{{ u.email }}</td>
                    <td>{{ u.full_name or "-" }}</td>
                    <td>{{ u.role.value if u.role else "-" }}</td>
                    <td>
                        {% if assigned_sites %}
                            {% for site in assigned_sites %}
                                {{ site.name or site.nome or "-" }}
                                {% if site.code and site.city %}
                                    <span class="text-muted">({{ site.code }}, {{ site.city }})</span>
                                {% elif site.code %}
                                    <span class="text-muted">({{ site.code }})</span>
                                {% elif site.city %}
                                    <span class="text-muted">({{ site.city }})</span>
                                {% endif %}
                                {% if not loop.last %}<br />{% endif %}
                            {% endfor %}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td>{{ u.language or "-" }}</td>
                    <td>
                        {% if u.is_active %}
                        <span class="badge badge-success">
                            {% if lang == 'fr' %}Actif{% else %}Attivo{% endif %}
                        </span>
                        {% else %}
                        <span class="badge badge-danger">
                            {% if lang == 'fr' %}D√©sactiv√©{% else %}Disattivato{% endif %}
                        </span>
                        {% endif %}
                    </td>
                    <td class="table-actions">
                        {% if has_perm(user, 'users.update') %}
                        <a class="btn btn-secondary btn-sm" href="/manager/utenti/{{ u.id }}/modifica">
                            ‚úèÔ∏è {% if lang == 'fr' %}Modifier{% else %}Modifica{% endif %}
                        </a>
                        <a class="btn btn-secondary btn-sm" href="/manager/utenti/{{ u.id }}/reset-password">
                            üîê {% if lang == 'fr' %}R√©initialiser{% else %}Reset password{% endif %}
                        </a>
                        {% endif %}
                        {% if has_perm(user, 'users.delete') %}
                        <form method="post" action="/manager/utenti/{{ u.id }}/toggle-attivo" style="display:inline;">
                            {% if u.is_active %}
                            <button type="submit" class="btn btn-secondary btn-sm">
                                ‚õî {% if lang == 'fr' %}D√©sactiver{% else %}Disattiva{% endif %}
                            </button>
                            {% else %}
                            <button type="submit" class="btn btn-secondary btn-sm">
                                ‚úÖ {% if lang == 'fr' %}Activer{% else %}Attiva{% endif %}
                            </button>
                            {% endif %}
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="table-empty">
                        {% if lang == 'fr' %}
                            Aucun utilisateur enregistr√© pour le moment.
                        {% else %}
                            Nessun utente presente al momento.
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
