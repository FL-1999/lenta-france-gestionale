{% extends "shared/base.html" %}
{% set lang = request.cookies.get('lang', 'it') %}

{% block title %}
    {% if lang == 'fr' %}Magasin ‚Äì Manager{% else %}Magazzino ‚Äì Manager{% endif %}
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-main">
        <h1 class="page-title">üì¶ {% if lang == 'fr' %}Magasin{% else %}Magazzino{% endif %}</h1>
        <p class="page-subtitle">
            {% if lang == 'fr' %}
                G√©rez les articles du magasin et les niveaux de stock.
            {% else %}
                Gestisci gli articoli di magazzino e le quantit√† disponibili.
            {% endif %}
        </p>
    </div>
    <div class="header-actions">
        <a href="{{ url_for('manager_magazzino_richieste') }}" class="btn btn-secondary">
            üßæ {% if lang == 'fr' %}Demandes{% else %}Richieste{% endif %}
        </a>
        <button type="button" class="btn btn-primary" data-modal-open="new-item">
            ‚ûï {% if lang == 'fr' %}Nouvelle carte{% else %}Nuova card{% endif %}
        </button>
    </div>
</div>

{% for categoria in categorie %}
    {% set category_items = items_by_categoria.get(categoria.key, []) %}
    <section class="magazzino-category">
        <div class="magazzino-category-header">
            <h2>
                {% if lang == 'fr' %}{{ categoria.label_fr }}{% else %}{{ categoria.label_it }}{% endif %}
            </h2>
        </div>
        <div class="magazzino-items-grid">
            {% if category_items %}
                {% for item in category_items %}
                    {% set non_disponibile = (not item.attivo) or (item.quantita_disponibile is not none and item.quantita_disponibile <= 0) %}
                    {% set sotto_soglia = (not non_disponibile) and (item.soglia_minima is not none) and (item.quantita_disponibile is not none) and (item.quantita_disponibile < item.soglia_minima) %}
                    <div class="card magazzino-item-card">
                        <div class="card-body">
                            <div class="magazzino-item-header">
                                <h3>{{ item.nome }}</h3>
                                {% if non_disponibile %}
                                    <span class="badge badge-muted">{% if lang == 'fr' %}Indisponible{% else %}Non disponibile{% endif %}</span>
                                {% elif sotto_soglia %}
                                    <span class="badge badge-danger">{% if lang == 'fr' %}Sous seuil{% else %}Sotto soglia{% endif %}</span>
                                {% else %}
                                    <span class="badge badge-success">OK</span>
                                {% endif %}
                            </div>
                            <p class="magazzino-item-meta">
                                <strong>{% if lang == 'fr' %}Code{% else %}Codice{% endif %}:</strong>
                                {{ item.codice or '‚Äî' }}
                            </p>
                            <p class="magazzino-item-desc">{{ item.descrizione or '‚Äî' }}</p>
                            <div class="magazzino-item-stats">
                                <div>
                                    <span class="label">{% if lang == 'fr' %}Quantit√© disponible{% else %}Quantit√† disponibile{% endif %}</span>
                                    <span class="kpi-value">
                                        {% if item.quantita_disponibile is not none %}
                                            {{ item.quantita_disponibile }}
                                        {% else %}
                                            ‚Äî
                                        {% endif %}
                                    </span>
                                </div>
                                <div>
                                    <span class="label">{% if lang == 'fr' %}Seuil minimum{% else %}Soglia minima{% endif %}</span>
                                    <span class="value">{{ item.soglia_minima if item.soglia_minima is not none else '‚Äî' }}</span>
                                </div>
                            </div>
                            <details>
                                <summary class="btn btn-primary btn-sm">‚¨áÔ∏è {% if lang == 'fr' %}D√©stockage{% else %}Scarico{% endif %}</summary>
                                <form method="post" action="{{ url_for('manager_magazzino_scarico') }}" style="margin-top: 0.75rem;">
                                    <input type="hidden" name="item_id" value="{{ item.id }}">
                                    <div class="form-grid-2">
                                        <div class="form-field">
                                            <label>{% if lang == 'fr' %}Quantit√©{% else %}Quantit√†{% endif %}*</label>
                                            <input type="number" name="quantita" min="0" step="0.01" required>
                                        </div>
                                        <div class="form-field">
                                            <label>{% if lang == 'fr' %}Chantier{% else %}Cantiere{% endif %}*</label>
                                            <select name="cantiere_id" required>
                                                <option value="">{% if lang == 'fr' %}S√©lectionner{% else %}Seleziona{% endif %}</option>
                                                {% for cantiere in cantieri %}
                                                    <option value="{{ cantiere.id }}">{{ cantiere.name }}{% if cantiere.code %} ({{ cantiere.code }}){% endif %}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-field">
                                        <label>{% if lang == 'fr' %}Notes{% else %}Note{% endif %}</label>
                                        <textarea name="note" placeholder="{% if lang == 'fr' %}Informations compl√©mentaires{% else %}Indicazioni aggiuntive{% endif %}"></textarea>
                                    </div>
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            ‚¨áÔ∏è {% if lang == 'fr' %}Confirmer{% else %}Conferma scarico{% endif %}
                                        </button>
                                    </div>
                                </form>
                            </details>
                            <div class="card-actions">
                                <a href="{{ url_for('manager_magazzino_edit', item_id=item.id) }}" class="btn btn-secondary btn-sm">
                                    ‚úèÔ∏è {% if lang == 'fr' %}Modifier{% else %}Modifica{% endif %}
                                </a>
                                <form method="post" action="{{ url_for('manager_magazzino_delete', item_id=item.id) }}">
                                    <button type="submit" class="btn btn-danger btn-sm"
                                            onclick="return confirm('{% if lang == 'fr' %}Supprimer cet article ?{% else %}Eliminare questo articolo?{% endif %}');">
                                        üóëÔ∏è {% if lang == 'fr' %}Supprimer{% else %}Elimina{% endif %}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="card magazzino-item-card">
                    <div class="card-body">
                        <p class="magazzino-item-desc">
                            {% if lang == 'fr' %}
                                Aucun article dans cette cat√©gorie.
                            {% else %}
                                Nessun articolo in questa categoria.
                            {% endif %}
                        </p>
                    </div>
                </div>
            {% endif %}
        </div>
    </section>
{% endfor %}

<div class="modal" id="new-item-modal" aria-hidden="true">
    <div class="modal-backdrop" data-modal-close></div>
    <div class="modal-content card">
        <div class="card-body">
            <div class="modal-header">
                <h2>
                    {% if lang == 'fr' %}Nouvelle carte{% else %}Nuova card{% endif %}
                </h2>
                <button type="button" class="btn btn-secondary btn-sm" data-modal-close>‚úñ</button>
            </div>
            <form method="post" action="{{ url_for('manager_magazzino_create') }}">
                <div class="form-grid-2">
                    <div class="form-field">
                        <label>{% if lang == 'fr' %}Nom{% else %}Nome{% endif %}*</label>
                        <input type="text" name="nome" required>
                    </div>
                    <div class="form-field">
                        <label>{% if lang == 'fr' %}Code article{% else %}Codice articolo{% endif %}*</label>
                        <input type="text" name="codice" required>
                    </div>
                    <div class="form-field">
                        <label>{% if lang == 'fr' %}Cat√©gorie{% else %}Categoria{% endif %}</label>
                        <select name="categoria" required>
                            {% for categoria in categorie %}
                                <option value="{{ categoria.key }}">
                                    {% if lang == 'fr' %}{{ categoria.label_fr }}{% else %}{{ categoria.label_it }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-field">
                        <label>{% if lang == 'fr' %}Quantit√© disponible{% else %}Quantit√† disponibile{% endif %}</label>
                        <input type="number" name="quantita_disponibile" step="0.01" min="0">
                    </div>
                    <div class="form-field">
                        <label>{% if lang == 'fr' %}Seuil minimum{% else %}Soglia minima{% endif %}</label>
                        <input type="number" name="soglia_minima" step="0.01" min="0">
                    </div>
                </div>

                <div class="form-field">
                    <label>{% if lang == 'fr' %}Description{% else %}Descrizione{% endif %}</label>
                    <textarea name="descrizione"></textarea>
                </div>

                <div class="form-field">
                    <label class="checkbox">
                        <input type="checkbox" name="attivo" checked>
                        <span>{% if lang == 'fr' %}Actif{% else %}Attivo{% endif %}</span>
                    </label>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-modal-close>
                        {% if lang == 'fr' %}Annuler{% else %}Annulla{% endif %}
                    </button>
                    <button type="submit" class="btn btn-primary">
                        {% if lang == 'fr' %}Enregistrer{% else %}Salva{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    (() => {
        const openButton = document.querySelector('[data-modal-open="new-item"]');
        const modal = document.getElementById('new-item-modal');
        if (!openButton || !modal) {
            return;
        }
        const closeButtons = modal.querySelectorAll('[data-modal-close]');
        const focusableSelector = 'input, select, textarea, button';

        const openModal = () => {
            modal.classList.add('is-open');
            modal.setAttribute('aria-hidden', 'false');
            const firstInput = modal.querySelector(focusableSelector);
            if (firstInput) {
                firstInput.focus();
            }
        };

        const closeModal = () => {
            modal.classList.remove('is-open');
            modal.setAttribute('aria-hidden', 'true');
            openButton.focus();
        };

        openButton.addEventListener('click', openModal);
        closeButtons.forEach((button) => {
            button.addEventListener('click', closeModal);
        });

        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
    })();
</script>
{% endblock %}
