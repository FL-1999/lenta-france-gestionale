{% extends "shared/base.html" %}
{% set lang = request.cookies.get('lang', 'it') %}

{% block title %}
    {% if lang == 'fr' %}Magasin ‚Äì Manager{% else %}Magazzino ‚Äì Manager{% endif %}
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-main">
        <h1 class="page-title">üì¶ {% if lang == 'fr' %}Magasin{% else %}Magazzino{% endif %}</h1>
        <p class="page-subtitle">
            {% if lang == 'fr' %}
                G√©rez les articles du magasin et les niveaux de stock.
            {% else %}
                Gestisci gli articoli di magazzino e le quantit√† disponibili.
            {% endif %}
        </p>
    </div>
    <div class="header-actions">
        <a href="{{ url_for('manager_magazzino_sotto_soglia') }}" class="btn btn-secondary">
            üìâ {% if lang == 'fr' %}Sous seuil{% else %}Sotto soglia{% endif %}
        </a>
        <a href="{{ url_for('manager_magazzino_movimenti') }}" class="btn btn-secondary">
            üìä {% if lang == 'fr' %}Mouvements{% else %}Movimenti{% endif %}
        </a>
        <a href="{{ url_for('manager_magazzino_richieste') }}" class="btn btn-secondary">
            üßæ {% if lang == 'fr' %}Demandes{% else %}Richieste{% endif %}
        </a>
        <a href="{{ url_for('manager_magazzino_categorie_list') }}" class="btn btn-secondary">
            üóÇÔ∏è {% if lang == 'fr' %}Cat√©gories{% else %}Macro categorie{% endif %}
        </a>
        <button type="button" class="btn btn-secondary" data-modal-open="new-macro">
            ‚ûï {% if lang == 'fr' %}Nouvelle macro{% else %}Nuova macro{% endif %}
        </button>
        <button type="button" class="btn btn-primary" data-modal-open="new-item">
            ‚ûï {% if lang == 'fr' %}Nouvelle carte{% else %}Nuova card{% endif %}
        </button>
    </div>
</div>

{% set ok = request.query_params.get('ok') %}
{% set err = request.query_params.get('err') %}
{% if ok %}
    <div class="alert alert-success">
        {% if ok == 'carico' %}
            {% if lang == 'fr' %}Chargement enregistr√© avec succ√®s.{% else %}Carico registrato con successo.{% endif %}
        {% elif ok == 'scarico' %}
            {% if lang == 'fr' %}D√©chargement enregistr√© avec succ√®s.{% else %}Scarico registrato con successo.{% endif %}
        {% else %}
            {% if lang == 'fr' %}Op√©ration termin√©e avec succ√®s.{% else %}Operazione completata con successo.{% endif %}
        {% endif %}
    </div>
{% endif %}
{% if err %}
    <div class="alert alert-danger">
        {% if err == 'item_non_trovato' %}
            {% if lang == 'fr' %}Article introuvable.{% else %}Articolo non trovato.{% endif %}
        {% elif err == 'quantita_non_valida' %}
            {% if lang == 'fr' %}Quantit√© non valide.{% else %}Quantit√† non valida.{% endif %}
        {% elif err == 'quantita_insufficiente' %}
            {% if lang == 'fr' %}Quantit√© insuffisante en stock.{% else %}Quantit√† insufficiente in magazzino.{% endif %}
        {% else %}
            {% if lang == 'fr' %}Erreur lors de l'op√©ration.{% else %}Errore durante l'operazione.{% endif %}
        {% endif %}
    </div>
{% endif %}

<div class="card" style="margin-bottom: var(--space-3);">
    <div class="card-header">
        <div class="card-title">
            üîç {% if lang == 'fr' %}Filtres magasin{% else %}Filtri magazzino{% endif %}
        </div>
    </div>
    <div class="card-body">
        <form method="get" class="form-grid">
            <div class="form-group">
                <label for="search_q" class="form-label">
                    {% if lang == 'fr' %}Code ou nom{% else %}Codice o nome{% endif %}
                </label>
                <input type="text" id="search_q" name="q" class="form-control" value="{{ filters.q or '' }}">
            </div>
            <div class="form-group">
                <label for="categoria" class="form-label">
                    {% if lang == 'fr' %}Macro cat√©gorie{% else %}Macro categoria{% endif %}
                </label>
                <select id="categoria" name="categoria" class="form-select">
                    <option value="">{% if lang == 'fr' %}Toutes{% else %}Tutte{% endif %}</option>
                    {% if fallback_categoria.id is none %}
                        <option value="none" {% if filters.categoria == 'none' %}selected{% endif %}>
                            {% if lang == 'fr' %}Sans cat√©gorie{% else %}Senza categoria{% endif %}
                        </option>
                    {% endif %}
                    {% for categoria in categorie %}
                        {% if categoria.id is not none %}
                            <option value="{{ categoria.id }}" {% if filters.categoria == categoria.id|string %}selected{% endif %}>
                                {{ categoria.nome }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">{% if lang == 'fr' %}Disponibilit√©{% else %}Disponibilit√†{% endif %}</label>
                <label class="checkbox">
                    <input type="checkbox" name="attivi" value="1" {% if filters.attivi %}checked{% endif %}>
                    <span>{% if lang == 'fr' %}Actifs uniquement{% else %}Solo attivi{% endif %}</span>
                </label>
                <label class="checkbox">
                    <input type="checkbox" name="sotto_soglia" value="1" {% if filters.sotto_soglia %}checked{% endif %}>
                    <span>{% if lang == 'fr' %}Sous seuil{% else %}Sotto soglia{% endif %}</span>
                </label>
                <label class="checkbox">
                    <input type="checkbox" name="esauriti" value="1" {% if filters.esauriti %}checked{% endif %}>
                    <span>{% if lang == 'fr' %}√âpuis√©s{% else %}Solo esauriti{% endif %}</span>
                </label>
            </div>
            <div class="form-group">
                <label class="form-label">{% if lang == 'fr' %}Actions{% else %}Azioni{% endif %}</label>
                <div style="display: flex; gap: var(--space-2); align-items: center; flex-wrap: wrap;">
                    <button type="submit" class="btn btn-primary">
                        {% if lang == 'fr' %}Filtrer{% else %}Filtra{% endif %}
                    </button>
                    <a href="{{ url_for('manager_magazzino_list') }}" class="btn btn-secondary">
                        {% if lang == 'fr' %}R√©initialiser{% else %}Reset filtri{% endif %}
                    </a>
                </div>
            </div>
        </form>
        <div style="margin-top: var(--space-2); font-weight: 600;">
            {% if lang == 'fr' %}R√©sultats{% else %}Risultati{% endif %}: {{ items_count }}
        </div>
    </div>
</div>

{% if items_count == 0 %}
    <div class="card" style="margin-bottom: var(--space-3);">
        <div class="card-body">
            <p class="magazzino-item-desc">
                {% if lang == 'fr' %}
                    Aucun r√©sultat avec ces filtres.
                {% else %}
                    Nessun risultato con questi filtri.
                {% endif %}
            </p>
        </div>
    </div>
{% endif %}

{% for section in categorie_sections %}
    {% set category_items = section["items"] %}
    {% if category_items %}
        <section class="magazzino-category">
            <div class="magazzino-category-header" style="display: flex; flex-direction: column; gap: var(--space-2);">
                <div style="display: flex; justify-content: space-between; gap: var(--space-2); flex-wrap: wrap; align-items: center;">
                    <h2 style="display: flex; align-items: center; gap: var(--space-2);">
                        <span class="badge badge-{{ section.color }}" style="{{ section.color_style }}">
                            {{ section.icon }}
                        </span>
                        {% if section.cat.id == fallback_categoria.id %}
                            {% if lang == 'fr' %}Sans cat√©gorie{% else %}Senza categoria{% endif %}
                        {% else %}
                            {{ section.cat.nome }}
                        {% endif %}
                    </h2>
                    {% if section.cat.id is not none %}
                        <a href="{{ url_for('manager_magazzino_new') }}?categoria_id={{ section.cat.id }}" class="btn btn-secondary btn-sm">
                            ‚ûï {% if lang == 'fr' %}Nouvel article dans cette macro{% else %}Nuovo articolo in questa macro{% endif %}
                        </a>
                    {% endif %}
                </div>
                <div style="display: flex; gap: var(--space-3); flex-wrap: wrap; font-size: 0.85rem;">
                    <span><strong>{{ section.stats.total_items }}</strong> {% if lang == 'fr' %}articles{% else %}articoli{% endif %}</span>
                    <span><strong>{{ section.stats.sotto_soglia_count }}</strong> {% if lang == 'fr' %}sous seuil{% else %}sotto soglia{% endif %}</span>
                    <span><strong>{{ section.stats.esauriti_count }}</strong> {% if lang == 'fr' %}√©puis√©s{% else %}esauriti{% endif %}</span>
                </div>
            </div>
            <div class="magazzino-items-grid">
                {% for item in category_items %}
                    {% set esaurito = (item.quantita_disponibile is not none) and (item.quantita_disponibile <= 0) %}
                    {% set sotto_soglia = (not esaurito) and (item.soglia_minima is not none) and (item.quantita_disponibile is not none) and (item.quantita_disponibile <= item.soglia_minima) %}
                    <div class="card magazzino-item-card">
                        <div class="card-body">
                            <div class="magazzino-item-header">
                                <div style="display: flex; align-items: center; gap: var(--space-2);">
                                    <form method="post" action="{{ url_for('manager_magazzino_preferito_toggle', item_id=item.id) }}" style="margin: 0;">
                                        <button type="submit" class="btn btn-secondary btn-sm" aria-label="{% if item.preferito %}{% if lang == 'fr' %}Retirer des favoris{% else %}Rimuovi dai preferiti{% endif %}{% else %}{% if lang == 'fr' %}Ajouter aux favoris{% else %}Aggiungi ai preferiti{% endif %}{% endif %}">
                                            {% if item.preferito %}‚òÖ{% else %}‚òÜ{% endif %}
                                        </button>
                                    </form>
                                    <h3>{{ item.nome }}</h3>
                                </div>
                                {% if esaurito %}
                                    <span class="badge badge-danger">{% if lang == 'fr' %}√âpuis√©{% else %}Esaurito{% endif %}</span>
                                {% elif sotto_soglia %}
                                    <span class="badge badge-warning">{% if lang == 'fr' %}Sous seuil{% else %}Sotto soglia{% endif %}</span>
                                {% else %}
                                    <span class="badge badge-success">OK</span>
                                {% endif %}
                            </div>
                            <p class="magazzino-item-meta">
                                <strong>{% if lang == 'fr' %}Code{% else %}Codice{% endif %}:</strong>
                                {{ item.codice or '‚Äî' }}
                            </p>
                            <p class="magazzino-item-desc">{{ item.descrizione or '‚Äî' }}</p>
                            <div class="magazzino-item-stats">
                                <div class="magazzino-item-quantity">
                                    <span class="label">{% if lang == 'fr' %}Quantit√© disponible{% else %}Quantit√† disponibile{% endif %}</span>
                                    <span class="kpi-value">
                                        {% if item.quantita_disponibile is not none %}
                                            {{ item.quantita_disponibile }}
                                        {% else %}
                                            ‚Äî
                                        {% endif %}
                                    </span>
                                </div>
                                <div>
                                    <span class="label">{% if lang == 'fr' %}Seuil minimum{% else %}Soglia minima{% endif %}</span>
                                    <span class="value">{{ item.soglia_minima if item.soglia_minima is not none else '‚Äî' }}</span>
                                </div>
                            </div>
                            <div style="display: grid; gap: var(--space-2);">
                                <details>
                                    <summary class="btn btn-primary btn-sm">‚ûï {% if lang == 'fr' %}Chargement rapide{% else %}Carico rapido{% endif %}</summary>
                                    <form method="post" action="{{ url_for('manager_magazzino_carico_rapido', item_id=item.id) }}" style="margin-top: 0.75rem;">
                                        <div class="form-grid-2">
                                            <div class="form-field">
                                                <label>{% if lang == 'fr' %}Quantit√©{% else %}Quantit√†{% endif %}*</label>
                                                <input type="number" name="quantita" min="0.01" step="0.01" required>
                                            </div>
                                            <div class="form-field">
                                                <label>{% if lang == 'fr' %}Notes{% else %}Note{% endif %}</label>
                                                <input type="text" name="note" placeholder="{% if lang == 'fr' %}Optionnel{% else %}Opzionale{% endif %}">
                                            </div>
                                        </div>
                                        <div class="form-actions">
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                ‚ûï {% if lang == 'fr' %}Ajouter{% else %}Aggiungi{% endif %}
                                            </button>
                                        </div>
                                    </form>
                                </details>
                                <details>
                                    <summary class="btn btn-secondary btn-sm">‚ûñ {% if lang == 'fr' %}D√©stockage rapide{% else %}Scarico rapido{% endif %}</summary>
                                    <form method="post" action="{{ url_for('manager_magazzino_scarico_rapido', item_id=item.id) }}" style="margin-top: 0.75rem;">
                                        <div class="form-grid-2">
                                            <div class="form-field">
                                                <label>{% if lang == 'fr' %}Quantit√©{% else %}Quantit√†{% endif %}*</label>
                                                <input type="number" name="quantita" min="0.01" step="0.01" required>
                                            </div>
                                            <div class="form-field">
                                                <label>{% if lang == 'fr' %}Chantier{% else %}Cantiere{% endif %}</label>
                                                <select name="cantiere_id">
                                                    <option value="">{% if lang == 'fr' %}Optionnel{% else %}Opzionale{% endif %}</option>
                                                    {% for cantiere in cantieri %}
                                                        <option value="{{ cantiere.id }}">{{ cantiere.name }}{% if cantiere.code %} ({{ cantiere.code }}){% endif %}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-field">
                                            <label>{% if lang == 'fr' %}Notes{% else %}Note{% endif %}</label>
                                            <input type="text" name="note" placeholder="{% if lang == 'fr' %}Optionnel{% else %}Opzionale{% endif %}">
                                        </div>
                                        <div class="form-actions">
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                ‚ûñ {% if lang == 'fr' %}Retirer{% else %}Scarica{% endif %}
                                            </button>
                                        </div>
                                    </form>
                                </details>
                            </div>
                            <div class="card-actions">
                                <a href="{{ url_for('manager_magazzino_duplicate', item_id=item.id) }}" class="btn btn-secondary btn-sm">
                                    üìÑ {% if lang == 'fr' %}Dupliquer{% else %}Duplica{% endif %}
                                </a>
                                <a href="{{ url_for('manager_magazzino_edit', item_id=item.id) }}" class="btn btn-secondary btn-sm">
                                    ‚úèÔ∏è {% if lang == 'fr' %}Modifier{% else %}Modifica{% endif %}
                                </a>
                                <form method="post" action="{{ url_for('manager_magazzino_delete', item_id=item.id) }}">
                                    <button type="submit" class="btn btn-danger btn-sm"
                                            onclick="return confirm('{% if lang == 'fr' %}Supprimer cet article ?{% else %}Eliminare questo articolo?{% endif %}');">
                                        üóëÔ∏è {% if lang == 'fr' %}Supprimer{% else %}Elimina{% endif %}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </section>
    {% endif %}
{% endfor %}

<div class="modal" id="new-macro-modal" aria-hidden="true">
    <div class="modal-backdrop" data-modal-close></div>
    <div class="modal-content card">
        <div class="card-body">
            <div class="modal-header">
                <h2>
                    {% if lang == 'fr' %}Nouvelle macro cat√©gorie{% else %}Nuova macro categoria{% endif %}
                </h2>
                <button type="button" class="btn btn-secondary btn-sm" data-modal-close>‚úñ</button>
            </div>
            <form method="post" action="{{ url_for('manager_magazzino_categorie_create') }}">
                <div class="form-grid-2">
                    <div class="form-field">
                        <label>{% if lang == 'fr' %}Nom{% else %}Nome{% endif %}*</label>
                        <input type="text" name="nome" required>
                    </div>
                    <div class="form-field">
                        <label>{% if lang == 'fr' %}Ordre{% else %}Ordine{% endif %}</label>
                        <input type="number" name="ordine" min="0" value="0">
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-field">
                        <label>{% if lang == 'fr' %}Ic√¥ne{% else %}Icona{% endif %}</label>
                        <input type="text" name="icon" maxlength="32" placeholder="üì¶"
                               value="{{ default_categoria_icon }}">
                    </div>
                    <div class="form-field">
                        <label>{% if lang == 'fr' %}Couleur{% else %}Colore{% endif %}</label>
                        <select name="color">
                            {% for option in color_options %}
                                <option value="{{ option }}" {% if option == default_categoria_color %}selected{% endif %}>
                                    {{ option|capitalize }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-field">
                    <label class="checkbox">
                        <input type="checkbox" name="attiva" checked>
                        <span>{% if lang == 'fr' %}Active{% else %}Attiva{% endif %}</span>
                    </label>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-modal-close>
                        {% if lang == 'fr' %}Annuler{% else %}Annulla{% endif %}
                    </button>
                    <button type="submit" class="btn btn-primary">
                        {% if lang == 'fr' %}Enregistrer{% else %}Salva{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal" id="new-item-modal" aria-hidden="true">
    <div class="modal-backdrop" data-modal-close></div>
    <div class="modal-content card">
        <div class="card-body">
            <div class="modal-header">
                <h2>
                    {% if lang == 'fr' %}Nouvelle carte{% else %}Nuova card{% endif %}
                </h2>
                <button type="button" class="btn btn-secondary btn-sm" data-modal-close>‚úñ</button>
            </div>
            <form method="post" action="{{ url_for('manager_magazzino_create') }}">
                <div class="form-grid-2">
                    <div class="form-field">
                        <label>{% if lang == 'fr' %}Nom{% else %}Nome{% endif %}*</label>
                        <input type="text" name="nome" required>
                    </div>
                    <div class="form-field">
                        <label>{% if lang == 'fr' %}Code article{% else %}Codice articolo{% endif %}*</label>
                        <input type="text" name="codice" required>
                    </div>
                    <div class="form-field">
                        <label>{% if lang == 'fr' %}Macro cat√©gorie{% else %}Macro categoria{% endif %}</label>
                        <select name="categoria_id">
                            <option value="">{% if lang == 'fr' %}Sans cat√©gorie{% else %}Senza categoria{% endif %}</option>
                            {% for categoria in categorie %}
                                {% if categoria.id is not none %}
                                    <option value="{{ categoria.id }}" {% if default_categoria_id == categoria.id %}selected{% endif %}>
                                        {{ categoria.nome }}
                                    </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-field">
                        <label>{% if lang == 'fr' %}Quantit√© disponible{% else %}Quantit√† disponibile{% endif %}</label>
                        <input type="number" name="quantita_disponibile" step="0.01" min="0">
                    </div>
                    <div class="form-field">
                        <label>{% if lang == 'fr' %}Seuil minimum{% else %}Soglia minima{% endif %}</label>
                        <input type="number" name="soglia_minima" step="0.01" min="0">
                    </div>
                </div>

                <div class="form-field">
                    <label>{% if lang == 'fr' %}Description{% else %}Descrizione{% endif %}</label>
                    <textarea name="descrizione"></textarea>
                </div>

                <div class="form-field">
                    <label class="checkbox">
                        <input type="checkbox" name="attivo" checked>
                        <span>{% if lang == 'fr' %}Actif{% else %}Attivo{% endif %}</span>
                    </label>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-modal-close>
                        {% if lang == 'fr' %}Annuler{% else %}Annulla{% endif %}
                    </button>
                    <button type="submit" class="btn btn-primary">
                        {% if lang == 'fr' %}Enregistrer{% else %}Salva{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    (() => {
        const openButtons = document.querySelectorAll('[data-modal-open]');
        const focusableSelector = 'input, select, textarea, button';

        const openModal = (modal, trigger) => {
            modal.classList.add('is-open');
            modal.setAttribute('aria-hidden', 'false');
            const firstInput = modal.querySelector(focusableSelector);
            if (firstInput) {
                firstInput.focus();
            }
            modal.dataset.modalTrigger = trigger;
        };

        const closeModal = (modal) => {
            modal.classList.remove('is-open');
            modal.setAttribute('aria-hidden', 'true');
            const triggerSelector = modal.dataset.modalTrigger;
            if (triggerSelector) {
                const trigger = document.querySelector(`[data-modal-open="${triggerSelector}"]`);
                if (trigger) {
                    trigger.focus();
                }
            }
        };

        openButtons.forEach((button) => {
            const modalName = button.getAttribute('data-modal-open');
            const modal = document.getElementById(`${modalName}-modal`);
            if (!modal) {
                return;
            }
            const closeButtons = modal.querySelectorAll('[data-modal-close]');
            button.addEventListener('click', () => openModal(modal, modalName));
            closeButtons.forEach((closeButton) => {
                closeButton.addEventListener('click', () => closeModal(modal));
            });

            modal.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeModal(modal);
                }
            });
        });
    })();
</script>
{% endblock %}
